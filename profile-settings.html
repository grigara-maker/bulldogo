<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nastaven√≠ - BULLDOGO</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';
        
        // Firebase konfigurace
        const firebaseConfig = {
            apiKey: "AIzaSyA1FEmsY458LLKQLGcUaOVXsYr3Ii55QeQ",
            authDomain: "inzerio-inzerce.firebaseapp.com",
            projectId: "inzerio-inzerce",
            storageBucket: "inzerio-inzerce.firebasestorage.app",
            messagingSenderId: "262039290071",
            appId: "1:262039290071:web:30af0eb1c65cd75e307092",
            measurementId: "G-7VD0ZE08M3"
        };
        
        // Inicializace Firebase
        const app = initializeApp(firebaseConfig);
        const firebaseAuth = getAuth(app);
        const firebaseDb = getFirestore(app);
        const analytics = getAnalytics(app);
        
        // Export pro glob√°ln√≠ pou≈æit√≠
        window.firebaseApp = app;
        window.firebaseAuth = firebaseAuth;
        window.firebaseDb = firebaseDb;
    </script>
</head>
<body>
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
        <!-- Logo Section -->
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">B</div>
                <span class="logo-text">
                    <span class="logo-bull">ULL</span>
                    <span class="logo-dogo">DOGO</span>
                </span>
            </div>
            <div class="header-buttons">
            </div>
        </div>

        <!-- Navigation Section -->
        <div class="navigation-section">
            <h3 class="nav-section-title">NAVIGACE</h3>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">
                        <i class="fas fa-home nav-icon"></i>
                        <span class="nav-text">Dom≈Ø</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="services.html" class="nav-link">
                        <i class="fas fa-list-alt nav-icon"></i>
                        <span class="nav-text">Slu≈æby</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="my-ads.html" class="nav-link">
                        <i class="fas fa-user nav-icon"></i>
                        <span class="nav-text">M√© inzer√°ty</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="index.html#features" class="nav-link">
                        <i class="fas fa-info-circle nav-icon"></i>
                        <span class="nav-text">O n√°s</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="index.html#contact" class="nav-link">
                        <i class="fas fa-envelope nav-icon"></i>
                        <span class="nav-text">Kontakt</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="chat.html" class="nav-link">
                        <i class="fas fa-comment-alt nav-icon"></i>
                        <span class="nav-text">Chat</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="top-ads.html" class="nav-link">
                        <i class="fas fa-fire nav-icon"></i>
                        <span class="nav-text">Topov√°n√≠</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="packages.html" class="nav-link">
                        <i class="fas fa-box nav-icon"></i>
                        <span class="nav-text">Bal√≠ƒçky</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Admin Section (shown only for admins) -->
        <div class="admin-section" id="adminSection" style="display: none;">
            <h3 class="nav-section-title">ADMIN</h3>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="uzivatele.html" class="nav-link">
                        <i class="fas fa-users nav-icon"></i>
                        <span class="nav-text">U≈æivatel√©</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="inzeraty.html" class="nav-link">
                        <i class="fas fa-list-alt nav-icon"></i>
                        <span class="nav-text">Inzer√°ty</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="statistiky.html" class="nav-link">
                        <i class="fas fa-chart-bar nav-icon"></i>
                        <span class="nav-text">Statistiky</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="nahlaseni.html" class="nav-link">
                        <i class="fas fa-flag nav-icon"></i>
                        <span class="nav-text">Nahl√°≈°en√≠</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Auth Buttons Section (shown when not logged in) -->
        <div class="auth-section" id="authSection">
            <button class="btn-login" onclick="showAuthModal('login')">
                <i class="fas fa-sign-in-alt"></i>
                <span>P≈ôihl√°≈°en√≠</span>
            </button>
            <button class="btn-register" onclick="showAuthModal('register')">
                <i class="fas fa-user-plus"></i>
                <span>Registrace</span>
            </button>
        </div>

        <!-- User Profile Section (shown when logged in) -->
        <div class="user-profile-section" id="userProfileSection" style="display: none;">
            <button class="btn-profile" onclick="window.location.href='profile.html'">
                <i class="fas fa-user-circle"></i>
                <span>Profil</span>
            </button>
            <button class="btn-logout" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Odhl√°sit se</span>
            </button>
        </div>
    </nav>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn" style="z-index: 9999 !important; pointer-events: auto !important; position: fixed !important;">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Toggle Button (when collapsed) -->
    <button class="sidebar-toggle-btn" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Main Content Wrapper -->
    <div class="main-content">
        <!-- Profile Hero Section -->
        <section class="page-hero">
            <div class="container">
                <div class="page-hero-card">
                    <div class="page-hero-inner">
                        <h2 class="services-title"><span class="title-text">Nastaven√≠</span><span class="title-accent"></span></h2>
                        <p class="page-hero-subtitle">Spr√°va va≈°eho √∫ƒçtu a p≈ôedvoleb</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Statistics Cards -->
        <section class="profile-stats-section">
            <div class="container">
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-ad"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="activeAdsCount">-</div>
                            <div class="stat-label">Aktivn√≠ inzer√°ty</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="avgRatingValue">-</div>
                            <div class="stat-label">Hodnocen√≠</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn" onclick="window.location.href='profile.html'">P≈ôehled</button>
            <button class="tab-btn" onclick="window.location.href='profile-services.html'">Moje slu≈æby</button>
            <button class="tab-btn" onclick="window.location.href='profile-ratings.html'">Hodnocen√≠</button>
            <button class="tab-btn active">Nastaven√≠</button>
            <button class="tab-btn" onclick="window.location.href='profile-plan.html'">Spravovat bal√≠ƒçek</button>
            <button class="tab-btn" onclick="window.location.href='top-ads.html'">Topov√°n√≠</button>
        </div>

        <!-- Settings Content -->
        <div class="settings-content">
            <div class="settings-sections">
                <!-- Profilov√° fotka (spoleƒçn√© pro Hobby + Firmu) -->
                <div class="settings-section" id="sectionAvatar">
                    <h3 class="settings-title">
                        <i class="fas fa-camera"></i>
                        Profilov√° fotka
                    </h3>
                    <div class="settings-form">
                        <div class="form-group" style="display:flex; flex-direction:column; align-items:center; gap:12px;">
                            <div style="width:96px; height:96px; border-radius:50%; overflow:hidden; background:#f3f4f6; display:flex; align-items:center; justify-content:center; border:1px solid #e5e7eb;">
                                <img id="profilePhotoPreview" src="" alt="Profilov√° fotka" style="width:100%; height:100%; object-fit:cover; display:none;" loading="lazy" decoding="async">
                                <i id="profilePhotoPlaceholder" class="fas fa-user" style="color:#9ca3af; font-size:34px;"></i>
                            </div>
                            <div class="profile-photo-actions" style="display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap; width:100%;">
                                <label for="profilePhotoInput" class="btn-save" style="cursor:pointer; align-items:center; gap:8px; white-space:nowrap; color: white;">
                                    <i class="fas fa-image"></i>
                                    Vybrat fotku
                                </label>
                                <input id="profilePhotoInput" type="file" accept="image/*" style="display:none;">
                                <button type="button" id="btnUploadProfilePhoto" class="btn-save" style="white-space:nowrap;">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    Nahr√°t
                                </button>
                                <button type="button" id="btnRemoveProfilePhoto" class="btn-save" style="white-space:nowrap;">
                                    <i class="fas fa-trash"></i>
                                    Odebrat
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Personal Information -->
                <div class="settings-section" id="sectionPersonal">
                    <h3 class="settings-title">
                        <i class="fas fa-user"></i>
                        Osobn√≠ informace
                    </h3>
                    <div class="settings-form">
                        <div class="form-group">
                            <label for="firstName">K≈ôestn√≠ jm√©no</label>
                            <input type="text" id="firstName" value="" class="form-input" placeholder="Zadejte va≈°e k≈ôestn√≠ jm√©no">
                        </div>
                        <div class="form-group">
                            <label for="lastName">P≈ô√≠jmen√≠</label>
                            <input type="text" id="lastName" value="" class="form-input" placeholder="Zadejte va≈°e p≈ô√≠jmen√≠">
                        </div>
                        <div class="form-group">
                            <label for="city">Mƒõsto</label>
                            <input type="text" id="city" value="" class="form-input" placeholder="Zadejte va≈°e mƒõsto">
                        </div>
                        <div class="form-group">
                            <label for="bio">O mnƒõ</label>
                            <textarea id="bio" class="form-input" rows="3" placeholder="Kr√°tk√Ω popis o sobƒõ..."></textarea>
                        </div>
                        <button type="button" onclick="savePersonalInfo()" class="btn-save" data-section="personal">
                            <i class="fas fa-save"></i>
                            Ulo≈æit zmƒõny
                        </button>
                    </div>
                </div>

                <!-- Business Information -->
                <div class="settings-section" id="sectionBusiness">
                    <h3 class="settings-title">
                        <i class="fas fa-briefcase"></i>
                        Obchodn√≠ informace
                    </h3>
                    <div class="settings-form">
                        <div class="form-group">
                            <label for="businessName">N√°zev firmy</label>
                            <input type="text" id="businessName" value="" class="form-input" placeholder="Zadejte n√°zev firmy">
                        </div>
                        <div class="form-group">
                            <label for="businessType">Typ podnik√°n√≠</label>
                            <select id="businessType" class="form-input">
                                <option value="">Vyberte typ podnik√°n√≠</option>
                                <option value="individual">OSVƒå</option>
                                <option value="company">Spoleƒçnost</option>
                                <option value="freelancer">Freelancer</option>
                                <option value="other">Jin√©</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="businessIco">Iƒå (Identifikaƒçn√≠ ƒç√≠slo)</label>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <input type="text" id="businessIco" value="" class="form-input" placeholder="Zadejte Iƒå firmy" style="flex:1;">
                                <button type="button" id="btnVerifyICOSettings" class="btn-save" style="white-space:nowrap;">
                                    <i class="fas fa-check-circle"></i>
                                    Ovƒõ≈ôit
                                </button>
                            </div>
                            <div id="icoStatusSettings" style="font-size:13px; margin-top:6px; color:#6b7280;"></div>
                        </div>
                        <div class="form-group">
                            <label for="businessDic">DIƒå (Da≈àov√© identifikaƒçn√≠ ƒç√≠slo)</label>
                            <input type="text" id="businessDic" value="" class="form-input" placeholder="Zadejte DIƒå firmy">
                        </div>
                        <div class="form-group">
                            <label for="businessAddress">Lokace</label>
                            <textarea id="businessAddress" class="form-input" rows="2" placeholder="Ulice, mƒõsto, PSƒå"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="businessWebsite">Webov√° str√°nka</label>
                            <input type="url" id="businessWebsite" class="form-input" placeholder="https://www.example.com">
                        </div>
                        <div class="form-group">
                            <label for="businessDescription">Popis u≈æivatele</label>
                            <textarea id="businessDescription" class="form-input" rows="4" placeholder="Kr√°tk√Ω popis o sobƒõ..."></textarea>
                        </div>
                        <button class="btn-save" data-section="business" onclick="saveBusinessInfo()">
                            <i class="fas fa-save"></i>
                            Ulo≈æit zmƒõny
                        </button>
                    </div>
                </div>

                <!-- Upozornƒõn√≠ -->
                <div class="settings-section" id="sectionNotifications">
                    <h3 class="settings-title">
                        <i class="fas fa-bell"></i>
                        Upozornƒõn√≠
                    </h3>
                    <div class="settings-form">
                        <div class="form-group">
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 0;">
                                <div>
                                    <label style="font-weight: 600; color: #1a1a2e; margin-bottom: 4px; display: block;">Nov√© zpr√°vy v chatu</label>
                                    <span style="font-size: 13px; color: #6b7280;">Dostanete e-mail, kdy≈æ v√°m nƒõkdo nap√≠≈°e novou zpr√°vu</span>
                                </div>
                                <label class="switch" style="position: relative; display: inline-block; width: 50px; height: 28px;">
                                    <input type="checkbox" id="chatNotifications" checked style="opacity: 0; width: 0; height: 0;">
                                    <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e5e7eb; transition: .3s; border-radius: 28px;"></span>
                                </label>
                            </div>
                        </div>
                        <button type="button" onclick="saveNotifications()" class="btn-save" style="margin-top: 16px;">
                            <i class="fas fa-save"></i>
                            Ulo≈æit upozornƒõn√≠
                        </button>
                    </div>
                </div>

                <!-- Account Settings -->
                <div class="settings-section">
                    <h3 class="settings-title">
                        <i class="fas fa-cog"></i>
                        Nastaven√≠ √∫ƒçtu
                    </h3>
                    <div class="settings-form">
                        <div class="form-group" style="margin-bottom: 6px;">
                            <label style="font-weight:700;">Zmƒõna emailu a telefonn√≠ho ƒç√≠sla</label>
                            <div style="font-size:13px; color:#6b7280; margin-top:4px;">
                                Pro zmƒõnu emailu nebo telefonn√≠ho ƒç√≠sla je pot≈ôeba souƒçasn√© heslo. Zmƒõny se projev√≠ i v datab√°zi.
                            </div>
                        </div>
                        
                        <!-- Aktu√°ln√≠ hodnoty -->
                        <div class="form-group" style="background: #f3f4f6; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                            <div style="margin-bottom: 8px;">
                                <label style="font-weight: 600; color: #6b7280; font-size: 13px;">Aktu√°ln√≠ email:</label>
                                <div id="currentEmailDisplay" style="color: #1a1a2e; font-weight: 500; margin-top: 4px;">-</div>
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #6b7280; font-size: 13px;">Aktu√°ln√≠ telefonn√≠ ƒç√≠slo:</label>
                                <div id="currentPhoneDisplay" style="color: #1a1a2e; font-weight: 500; margin-top: 4px;">-</div>
                            </div>
                        </div>

                        <!-- Zmƒõna emailu -->
                        <div class="form-group" style="margin-bottom: 6px;">
                            <label style="font-weight:600;">Zmƒõnit email</label>
                        </div>
                        <div class="form-group">
                            <label for="newEmail">Nov√Ω email</label>
                            <input type="email" id="newEmail" class="form-input" placeholder="Zadejte nov√Ω email">
                        </div>
                        <div class="form-group">
                            <label for="confirmEmail">Potvrdit nov√Ω email</label>
                            <input type="email" id="confirmEmail" class="form-input" placeholder="Zadejte nov√Ω email znovu">
                        </div>

                        <!-- Zmƒõna telefonu -->
                        <div class="form-group" style="margin-top: 20px; margin-bottom: 6px;">
                            <label style="font-weight:600;">Zmƒõnit telefonn√≠ ƒç√≠slo</label>
                        </div>
                        <div class="form-group">
                            <label for="newPhone">Nov√© telefonn√≠ ƒç√≠slo</label>
                            <input type="tel" id="newPhone" value="+420" class="form-input" placeholder="Zadejte nov√© telefonn√≠ ƒç√≠slo">
                        </div>

                        <!-- Heslo pro obƒõ zmƒõny -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label for="currentPasswordForChange">Souƒçasn√© heslo (povinn√© pro zmƒõnu)</label>
                            <input type="password" id="currentPasswordForChange" class="form-input" placeholder="Zadejte souƒçasn√© heslo">
                        </div>

                        <button class="btn-save" onclick="changeEmailAndPhone()">
                            <i class="fas fa-save"></i>
                            Ulo≈æit zmƒõny
                        </button>

                        <hr style="margin: 18px 0; border:0; border-top:1px solid #e5e7eb;">

                        <div class="form-group" style="margin-bottom: 6px;">
                            <label style="font-weight:700;">Zmƒõnit heslo</label>
                        </div>
                        <div class="form-group">
                            <label for="currentPassword">Souƒçasn√© heslo</label>
                            <input type="password" id="currentPassword" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Nov√© heslo</label>
                            <input type="password" id="newPassword" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Potvrdit heslo</label>
                            <input type="password" id="confirmPassword" class="form-input">
                        </div>
                        <button class="btn-save" onclick="changePassword()">
                            <i class="fas fa-key"></i>
                            Zmƒõnit heslo
                        </button>
                    </div>
                </div>


                <!-- Danger Zone -->
                <div class="settings-section danger-zone">
                    <h3 class="settings-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Nebezpeƒçn√° z√≥na
                    </h3>
                    <div class="settings-form">
                        <div class="danger-actions">
                            <button class="btn-danger" onclick="deleteAccount()">
                                <i class="fas fa-trash"></i>
                                Smazat √∫ƒçet
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Glob√°ln√≠ promƒõnn√© pro real-time listener
        let profileListener = null;
        let isInitialized = false;
        let isUserEditing = false; // Flag pro sledov√°n√≠, zda u≈æivatel pr√°vƒõ upravuje formul√°≈ô
        let editedFields = new Set(); // Sledov√°n√≠ pol√≠, kter√° u≈æivatel upravil

        // Export funkc√≠ pro glob√°ln√≠ pou≈æit√≠ - OKAM≈ΩITƒö (budou nastaveny po definici)

        // Inicializace po naƒçten√≠ DOM
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Inicializuji nastaven√≠ profilu');
            initializeSettings();
            loadUserProfile();
        });

        // Load user profile data
        async function loadUserProfile() {
            console.log('üîß Loading user profile...');
            try {
                // Wait for Firebase to be available
                const checkFirebase = setInterval(() => {
                    console.log('üîç Checking Firebase:', {
                        firebaseAuth: !!window.firebaseAuth,
                        firebaseDb: !!window.firebaseDb
                    });
                    if (window.firebaseAuth && window.firebaseDb) {
                        console.log('‚úÖ Firebase available, loading data');
                        clearInterval(checkFirebase);
                        loadUserData();
                        
                        // Listen for auth state changes
                        window.firebaseAuth.onAuthStateChanged((user) => {
                            console.log('üë§ Auth state changed on profile page:', user ? user.email : 'Not logged in');
                            if (user) {
                                loadUserData();
                            }
                        });
                    }
                }, 100);
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ profilu:', error);
            }
        }

        // Ulo≈æen√≠ osobn√≠ch informac√≠ - DEFINICE HNED
        async function savePersonalInfo() {
            console.log('üöÄ savePersonalInfo vol√°na!');
            try {
                // Guard: osobn√≠ informace ukl√°d√° jen Hobby (person)
                const t = normalizeUserType(window.__profileUserType);
                if (t === 'company') {
                    showMessage('Tato sekce je dostupn√° jen pro Hobby √∫ƒçet.', 'error');
                    return;
                }
                    console.log('üîç Kontroluji Firebase:', {
                        firebaseAuth: !!window.firebaseAuth,
                        firebaseDb: !!window.firebaseDb
                    });
                
                const currentUser = window.firebaseAuth.currentUser;
                console.log('üë§ Aktu√°ln√≠ u≈æivatel:', currentUser ? currentUser.uid : 'NEN√ç P≈òIHL√Å≈†EN');
                
                if (!currentUser) {
                    showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni!', 'error');
                    return;
                }

                // Z√≠skat hodnoty z formul√°≈ôe (email a telefon se u≈æ neukl√°daj√≠ zde)
                const firstNameEl = document.getElementById('firstName');
                const lastNameEl = document.getElementById('lastName');
                const cityEl = document.getElementById('city');
                const bioEl = document.getElementById('bio');
                
                const firstName = firstNameEl ? firstNameEl.value : '';
                const lastName = lastNameEl ? lastNameEl.value : '';
                const bioText = bioEl ? bioEl.value : '';
                
                // Kontrola zak√°zan√Ωch slov
                if (window.ProfanityFilter && bioText) {
                    const profanityCheck = window.ProfanityFilter.check(bioText);
                    if (!profanityCheck.isClean) {
                        showMessage('‚ö†Ô∏è V√°≈° popis obsahuje nevhodn√Ω obsah. Pros√≠m upravte text.', 'error');
                        return;
                    }
                }
                
                const personalData = {
                    firstName: firstName,
                    lastName: lastName,
                    name: `${firstName} ${lastName}`.trim(), // Zachovat i slo≈æen√© jm√©no pro kompatibilitu
                    // Email a telefon se u≈æ neukl√°daj√≠ zde - mƒõn√≠ se v sekci "Zmƒõna emailu a telefonn√≠ho ƒç√≠sla" s heslem
                    city: cityEl ? cityEl.value : '',
                    bio: bioText,
                    updatedAt: new Date()
                };

                console.log('üíæ Ukl√°d√°m osobn√≠ informace:', personalData);

                const { setDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const profileRef = doc(window.firebaseDb, 'users', currentUser.uid, 'profile', 'profile');
                
                console.log('üìù Cesta k dokumentu:', `users/${currentUser.uid}/profile/profile`);
                
                await setDoc(profileRef, personalData, { merge: true });

                console.log('‚úÖ Data √∫spƒõ≈°nƒõ ulo≈æena do Firebase');
                
                // Resetovat flagy po √∫spƒõ≈°n√©m ulo≈æen√≠
                isUserEditing = false;
                editedFields.clear();
                
                showMessage('‚úÖ Osobn√≠ informace byly ulo≈æeny!', 'success');

            } catch (error) {
                console.error('‚ùå Chyba p≈ôi ukl√°d√°n√≠ osobn√≠ch informac√≠:', error);
                showMessage('Nepoda≈ôilo se ulo≈æit osobn√≠ informace: ' + error.message, 'error');
            }
        }

        // Ulo≈æen√≠ obchodn√≠ch informac√≠ - DEFINICE HNED
        async function saveBusinessInfo() {
            console.log('üöÄ saveBusinessInfo vol√°na!');
            try {
                // Guard: obchodn√≠ informace ukl√°d√° jen Firma (company)
                const t = normalizeUserType(window.__profileUserType);
                if (t !== 'company') {
                    showMessage('Tato sekce je dostupn√° jen pro Firemn√≠ √∫ƒçet.', 'error');
                    return;
                }
                console.log('üîç Kontroluji Firebase:', {
                    firebaseAuth: !!window.firebaseAuth,
                    firebaseDb: !!window.firebaseDb
                });
                
                const currentUser = window.firebaseAuth.currentUser;
                console.log('üë§ Aktu√°ln√≠ u≈æivatel:', currentUser ? currentUser.uid : 'NEN√ç P≈òIHL√Å≈†EN');
                
                if (!currentUser) {
                    showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni!', 'error');
                    return;
                }

                // Z√≠skat hodnoty z formul√°≈ôe
                const businessNameEl = document.getElementById('businessName');
                const businessTypeEl = document.getElementById('businessType');
                const businessIcoEl = document.getElementById('businessIco');
                const businessDicEl = document.getElementById('businessDic');
                const businessAddressEl = document.getElementById('businessAddress');
                const businessWebsiteEl = document.getElementById('businessWebsite');
                const businessDescriptionEl = document.getElementById('businessDescription');
                
                console.log('üîç Elementy formul√°≈ôe:', {
                    businessName: !!businessNameEl,
                    businessType: !!businessTypeEl,
                    businessIco: !!businessIcoEl,
                    businessDic: !!businessDicEl,
                    businessAddress: !!businessAddressEl,
                    businessWebsite: !!businessWebsiteEl,
                    businessDescription: !!businessDescriptionEl
                });
                
                // Ovƒõ≈ôen√≠ IƒåO ‚Äì pokud je vyplnƒõno, mus√≠ b√Ωt √∫spƒõ≈°nƒõ ovƒõ≈ôeno tlaƒç√≠tkem
                const icoRaw = businessIcoEl ? businessIcoEl.value : '';
                const normalizedIco = normalizeICO(icoRaw);
                if (normalizedIco) {
                    const verifiedFlag = window.__icoVerified === true && window.__icoVerifiedValue === normalizedIco;
                    if (!verifiedFlag) {
                        showMessage('Nejd≈ô√≠ve ovƒõ≈ôte IƒåO tlaƒç√≠tkem Ovƒõ≈ôit.', 'error');
                        return;
                    }
                }

                const businessDescriptionText = businessDescriptionEl ? businessDescriptionEl.value : '';
                
                // Kontrola zak√°zan√Ωch slov
                if (window.ProfanityFilter && businessDescriptionText) {
                    const profanityCheck = window.ProfanityFilter.checkMultiple({
                        businessName: businessNameEl ? businessNameEl.value : '',
                        businessDescription: businessDescriptionText
                    });
                    if (!profanityCheck.isClean) {
                        showMessage('‚ö†Ô∏è V√°≈° text obsahuje nevhodn√Ω obsah. Pros√≠m upravte n√°zev nebo popis firmy.', 'error');
                        return;
                    }
                }
                
                const businessData = {
                        businessName: businessNameEl ? businessNameEl.value : '',
                        businessType: businessTypeEl ? businessTypeEl.value : '',
                        businessIco: normalizedIco || '',
                        businessDic: businessDicEl ? businessDicEl.value : '',
                        businessAddress: businessAddressEl ? businessAddressEl.value : '',
                        businessWebsite: businessWebsiteEl ? businessWebsiteEl.value.trim() : '',
                        businessDescription: businessDescriptionText,
                        // U firmy se businessAddress ukl√°d√° tak√© do location, aby se zobrazovala v profilu
                        location: businessAddressEl ? businessAddressEl.value : null,
                        updatedAt: new Date()
                    };

                console.log('üíæ Ukl√°d√°m obchodn√≠ informace:', businessData);

                const { setDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const profileRef = doc(window.firebaseDb, 'users', currentUser.uid, 'profile', 'profile');
                
                console.log('üìù Cesta k dokumentu:', `users/${currentUser.uid}/profile/profile`);
                
                await setDoc(profileRef, businessData, { merge: true });

                console.log('‚úÖ Data √∫spƒõ≈°nƒõ ulo≈æena do Firebase');
                showMessage('‚úÖ Obchodn√≠ informace byly ulo≈æeny!', 'success');

            } catch (error) {
                console.error('‚ùå Chyba p≈ôi ukl√°d√°n√≠ obchodn√≠ch informac√≠:', error);
                showMessage('Nepoda≈ôilo se ulo≈æit obchodn√≠ informace: ' + error.message, 'error');
            }
        }

        // ---- IƒåO ovƒõ≈ôov√°n√≠ (Hl√≠daƒçSt√°tu) ----
        function normalizeICO(input) {
            const digits = (input || '').toString().replace(/\D+/g, '');
            return digits.slice(0, 8);
        }

        async function validateICOWithARES(ico) {
            const n = normalizeICO(ico);
            if (n.length !== 8) return { ok: false, reason: 'IƒåO mus√≠ m√≠t 8 ƒç√≠slic.' };

            const fetchWithTimeout = (input, opts = {}) => {
                const { timeoutMs = 3000, ...rest } = opts;
                const ctrl = new AbortController();
                const t = setTimeout(() => ctrl.abort(), timeoutMs);
                return fetch(input, { ...rest, signal: ctrl.signal }).finally(() => clearTimeout(t));
            };

            // --- Hl√≠daƒçSt√°tu API ---
            // POZOR: API token by nemƒõl b√Ωt v klientsk√©m k√≥du, ale pro testov√°n√≠ ho m≈Ø≈æeme pou≈æ√≠t
            const hlidacToken = '36a6940d34774a5c90270f60ea73130b';
            const baseJson = [
                `https://api.hlidacstatu.cz/api/v2/firmy/ico/${n}`
            ];
            const localProxy = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
                ? baseJson.map(u => `http://localhost:8010/${u.replace('https://','')}`) : [];
            const jsonCandidates = [
                ...localProxy,
                ...baseJson,
                // Proxies pro CORS
                ...baseJson.map(u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`),
                ...baseJson.map(u => `https://thingproxy.freeboard.io/fetch/${u}`),
                ...baseJson.map(u => `https://cors.isomorphic-git.org/${u}`)
            ];

            for (const directUrl of jsonCandidates) {
                // Direct
                try {
                    const r = await fetchWithTimeout(directUrl, { 
                        headers: { 
                            'Accept': 'application/json',
                            'Authorization': `Token ${hlidacToken}`
                        }, 
                        timeoutMs: 3000 
                    });
                    if (r.ok) {
                        const data = await r.json().catch(() => null);
                        if (data) {
                            // Hl√≠daƒçSt√°tu API vrac√≠ FirmaDTO: { ico, jmeno, datoveSchranky, zalozena }
                            const name = data.jmeno || data.nazev || '';
                            if (data.ico && name) return { ok: true, name, seat: null };
                        }
                    }
                } catch (_) {}
                // Proxy (CORS) - POZOR: proxy nemus√≠ p≈ôedat Authorization header
                try {
                    const proxied = `https://api.allorigins.win/raw?url=${encodeURIComponent(directUrl)}`;
                    const r2 = await fetchWithTimeout(proxied, { headers: { 'Accept': 'application/json' }, timeoutMs: 3000 });
                    if (r2.ok) {
                        const data = await r2.json().catch(() => null);
                        if (data) {
                            const name = data.jmeno || data.nazev || '';
                            if (data.ico && name) return { ok: true, name, seat: null };
                        }
                    }
                } catch (_) {}
            }

            return { ok: false, reason: 'Subjekt s t√≠mto IƒåO nebyl nalezen.' };
        }

        // UI logika pro ovƒõ≈ôen√≠ IƒåO v Nastaven√≠
        document.addEventListener('DOMContentLoaded', () => {
            const icoInput = document.getElementById('businessIco');
            const verifyBtn = document.getElementById('btnVerifyICOSettings');
            const statusEl = document.getElementById('icoStatusSettings');
            const nameEl = document.getElementById('businessName');
            const addrEl = document.getElementById('businessAddress');

            // Resetovat flag p≈ôi zmƒõnƒõ IƒåO
            if (icoInput) {
                icoInput.addEventListener('input', () => {
                    window.__icoVerified = false;
                    window.__icoVerifiedValue = '';
                    if (statusEl) { statusEl.style.color = '#6b7280'; statusEl.textContent = ''; }
                });
            }

            if (verifyBtn) {
                verifyBtn.addEventListener('click', async () => {
                    try {
                        verifyBtn.disabled = true;
                        if (statusEl) { statusEl.style.color = '#6b7280'; statusEl.textContent = 'Ovƒõ≈ôuji IƒåO‚Ä¶'; }
                        const val = icoInput ? icoInput.value : '';
                        const res = await validateICOWithARES(val);
                        if (res.ok) {
                            const n = normalizeICO(val);
                            if (icoInput) icoInput.value = n;
                            window.__icoVerified = true;
                            window.__icoVerifiedValue = n;
                            if (statusEl) { statusEl.style.color = '#28a745'; statusEl.textContent = 'IƒåO ovƒõ≈ôeno'; }
                            // P≈ôedvyplnit n√°zev/s√≠dlo pokud pr√°zdn√©
                            if (res.name && nameEl && !nameEl.value) nameEl.value = res.name;
                            if (res.seat && addrEl && !addrEl.value && res.seat.text) addrEl.value = res.seat.text;
                        } else {
                            window.__icoVerified = false;
                            window.__icoVerifiedValue = '';
                            if (statusEl) { statusEl.style.color = '#dc3545'; statusEl.textContent = res.reason || 'IƒåO se nepoda≈ôilo ovƒõ≈ôit'; }
                        }
                    } finally {
                        verifyBtn.disabled = false;
                    }
                });
            }
        });

        // Ulo≈æen√≠ p≈ôedvoleb - DEFINICE HNED
        async function savePreferences() {
            console.log('üöÄ savePreferences vol√°na!');
            try {
                console.log('üîç Kontroluji Firebase:', {
                    firebaseAuth: !!window.firebaseAuth,
                    firebaseDb: !!window.firebaseDb
                });
                
                const currentUser = window.firebaseAuth.currentUser;
                console.log('üë§ Aktu√°ln√≠ u≈æivatel:', currentUser ? currentUser.uid : 'NEN√ç P≈òIHL√Å≈†EN');
                
                if (!currentUser) {
                    showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni!', 'error');
                    return;
                }

                // Z√≠skat hodnoty z formul√°≈ôe
                const emailNotificationsEl = document.getElementById('emailNotifications');
                const smsNotificationsEl = document.getElementById('smsNotifications');
                const marketingEmailsEl = document.getElementById('marketingEmails');
                
                console.log('üîç Elementy formul√°≈ôe:', {
                    emailNotifications: !!emailNotificationsEl,
                    smsNotifications: !!smsNotificationsEl,
                    marketingEmails: !!marketingEmailsEl
                });
                
                const preferencesData = {
                    emailNotifications: emailNotificationsEl ? emailNotificationsEl.checked : true,
                    smsNotifications: smsNotificationsEl ? smsNotificationsEl.checked : false,
                    marketingEmails: marketingEmailsEl ? marketingEmailsEl.checked : false,
                    updatedAt: new Date()
                };

                console.log('üíæ Ukl√°d√°m p≈ôedvolby:', preferencesData);

                const { setDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const profileRef = doc(window.firebaseDb, 'users', currentUser.uid, 'profile', 'profile');
                
                console.log('üìù Cesta k dokumentu:', `users/${currentUser.uid}/profile/profile`);
                
                await setDoc(profileRef, preferencesData, { merge: true });

                console.log('‚úÖ Data √∫spƒõ≈°nƒõ ulo≈æena do Firebase');
                showMessage('‚úÖ P≈ôedvolby byly ulo≈æeny!', 'success');

            } catch (error) {
                console.error('‚ùå Chyba p≈ôi ukl√°d√°n√≠ p≈ôedvoleb:', error);
                showMessage('Nepoda≈ôilo se ulo≈æit p≈ôedvolby: ' + error.message, 'error');
            }
        }

        // Zmƒõna emailu a telefonu - DEFINICE HNED
        async function changeEmailAndPhone() {
            try {
                const currentUser = window.firebaseAuth.currentUser;
                if (!currentUser) {
                    showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni!', 'error');
                    return;
                }

                const newEmail = (document.getElementById('newEmail')?.value || '').toString().trim();
                const confirmEmail = (document.getElementById('confirmEmail')?.value || '').toString().trim();
                const newPhone = (document.getElementById('newPhone')?.value || '').toString().trim();
                const currentPassword = (document.getElementById('currentPasswordForChange')?.value || '').toString();

                // Kontrola, zda je alespo≈à jedna zmƒõna
                if (!newEmail && !newPhone) {
                    showMessage('Zadejte nov√Ω email nebo telefonn√≠ ƒç√≠slo!', 'error');
                    return;
                }

                // Heslo je povinn√©
                if (!currentPassword) {
                    showMessage('Pro zmƒõnu emailu nebo telefonu je pot≈ôeba souƒçasn√© heslo!', 'error');
                    return;
                }

                // Validace emailu (pokud je vyplnƒõn)
                if (newEmail) {
                    if (newEmail !== confirmEmail) {
                        showMessage('Emaily se neshoduj√≠!', 'error');
                        return;
                    }

                    const emailParts = newEmail.split('@');
                    if (emailParts.length !== 2) {
                        showMessage('‚ö†Ô∏è Email mus√≠ obsahovat zavin√°ƒç (@).', 'error');
                        return;
                    }

                    const beforeAt = emailParts[0].trim();
                    const afterAt = emailParts[1].trim();

                    if (!beforeAt || beforeAt.length === 0) {
                        showMessage('‚ö†Ô∏è Email mus√≠ obsahovat text p≈ôed zavin√°ƒçem.', 'error');
                        return;
                    }

                    if (!afterAt || afterAt.length === 0) {
                        showMessage('‚ö†Ô∏è Email mus√≠ obsahovat text po zavin√°ƒçi.', 'error');
                        return;
                    }

                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(newEmail)) {
                        showMessage('‚ö†Ô∏è Email nen√≠ ve spr√°vn√©m form√°tu (nap≈ô. jmeno@domena.cz).', 'error');
                        return;
                    }
                }

                // Validace telefonu (pokud je vyplnƒõn)
                let normalizedPhone = null;
                if (newPhone && newPhone !== '+420') {
                    const phoneWithoutPrefix = newPhone.replace(/^\+420\s*/, '').replace(/^420\s*/, '').replace(/\s+/g, '');
                    const digitsAfterPrefix = phoneWithoutPrefix.replace(/\D/g, '');
                    
                    if (digitsAfterPrefix.length < 9) {
                        showMessage('‚ö†Ô∏è Telefonn√≠ ƒç√≠slo mus√≠ obsahovat alespo≈à 9 ƒç√≠slic za p≈ôedvolbou.', 'error');
                        return;
                    }

                    // Normalizace telefonu
                    const cleaned = newPhone.replace(/\s+/g, '').trim();
                    if (cleaned.startsWith('+420')) {
                        normalizedPhone = cleaned;
                    } else if (cleaned.startsWith('420')) {
                        normalizedPhone = '+' + cleaned;
                    } else if (cleaned.startsWith('00')) {
                        normalizedPhone = '+' + cleaned.slice(2);
                    } else if (cleaned.startsWith('+')) {
                        normalizedPhone = cleaned;
                    } else {
                        normalizedPhone = '+420' + cleaned.replace(/\D/g, '');
                    }
                }

                // Re-autentifikace s heslem
                const { reauthenticateWithCredential, EmailAuthProvider } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                await reauthenticateWithCredential(currentUser, credential);

                // Zmƒõna emailu v Auth (pokud je vyplnƒõn)
                if (newEmail) {
                    const { updateEmail, sendEmailVerification } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                    await updateEmail(currentUser, newEmail);
                    try { await sendEmailVerification(currentUser); } catch (e) { /* noop */ }
                }

                // Aktualizace v datab√°zi
                const { setDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const uid = currentUser.uid;
                const updateData = { updatedAt: new Date() };
                
                if (newEmail) {
                    updateData.email = newEmail;
                }
                if (normalizedPhone) {
                    updateData.phone = normalizedPhone;
                }

                // Aktualizace v root users dokumentu
                await setDoc(doc(window.firebaseDb, 'users', uid), updateData, { merge: true });
                
                // Aktualizace v profilu
                await setDoc(doc(window.firebaseDb, 'users', uid, 'profile', 'profile'), updateData, { merge: true });

                // Vyƒçistit formul√°≈ô
                document.getElementById('newEmail').value = '';
                document.getElementById('confirmEmail').value = '';
                document.getElementById('newPhone').value = '+420';
                document.getElementById('currentPasswordForChange').value = '';

                // Aktualizovat zobrazen√≠ aktu√°ln√≠ch hodnot
                await updateFormFields(await loadUserProfile());
                
                // Resetovat flagy po √∫spƒõ≈°n√©m ulo≈æen√≠
                isUserEditing = false;
                editedFields.clear();

                showMessage('‚úÖ Zmƒõny byly √∫spƒõ≈°nƒõ ulo≈æeny!', 'success');
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi zmƒõnƒõ emailu/telefonu:', error);
                let errorMessage = 'Nepoda≈ôilo se zmƒõnit √∫daje';
                if (error?.code === 'auth/wrong-password') {
                    errorMessage = 'Souƒçasn√© heslo je nespr√°vn√©';
                } else if (error?.code === 'auth/invalid-email') {
                    errorMessage = 'Neplatn√Ω email';
                } else if (error?.code === 'auth/email-already-in-use') {
                    errorMessage = 'Tento email u≈æ je pou≈æ√≠v√°n jin√Ωm √∫ƒçtem';
                } else if (error?.code === 'auth/requires-recent-login') {
                    errorMessage = 'Pro zmƒõnu √∫daj≈Ø se mus√≠te znovu p≈ôihl√°sit';
                }
                showMessage(errorMessage, 'error');
            }
        }

        // Zmƒõna emailu - DEFINICE HNED (zachov√°na pro kompatibilitu, ale nepou≈æ√≠v√° se)
        async function changeEmail() {
            try {
                const currentUser = window.firebaseAuth.currentUser;
                if (!currentUser) {
                    showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni!', 'error');
                    return;
                }

                const newEmail = (document.getElementById('newEmail')?.value || '').toString().trim();
                const confirmEmail = (document.getElementById('confirmEmail')?.value || '').toString().trim();
                const currentPassword = (document.getElementById('currentPasswordForEmail')?.value || '').toString();

                if (!newEmail || !confirmEmail || !currentPassword) {
                    showMessage('Vypl≈àte v≈°echna pole pro zmƒõnu emailu!', 'error');
                    return;
                }
                
                // Validace emailu - mus√≠ obsahovat text p≈ôed @ a po @, mus√≠ obsahovat zavin√°ƒç
                const emailParts = newEmail.split('@');
                if (emailParts.length !== 2) {
                    showMessage('‚ö†Ô∏è Email mus√≠ obsahovat zavin√°ƒç (@).', 'error');
                    const emailEl = document.getElementById('newEmail');
                    if (emailEl) emailEl.focus();
                    return;
                }
                
                const beforeAt = emailParts[0].trim();
                const afterAt = emailParts[1].trim();
                
                if (!beforeAt || beforeAt.length === 0) {
                    showMessage('‚ö†Ô∏è Email mus√≠ obsahovat text p≈ôed zavin√°ƒçem.', 'error');
                    const emailEl = document.getElementById('newEmail');
                    if (emailEl) emailEl.focus();
                    return;
                }
                
                if (!afterAt || afterAt.length === 0) {
                    showMessage('‚ö†Ô∏è Email mus√≠ obsahovat text po zavin√°ƒçi.', 'error');
                    const emailEl = document.getElementById('newEmail');
                    if (emailEl) emailEl.focus();
                    return;
                }
                
                // Z√°kladn√≠ kontrola form√°tu emailu
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(newEmail)) {
                    showMessage('‚ö†Ô∏è Email nen√≠ ve spr√°vn√©m form√°tu (nap≈ô. jmeno@domena.cz).', 'error');
                    const emailEl = document.getElementById('newEmail');
                    if (emailEl) emailEl.focus();
                    return;
                }
                
                if (newEmail !== confirmEmail) {
                    showMessage('Emaily se neshoduj√≠!', 'error');
                    return;
                }

                console.log('‚úâÔ∏è Mƒõn√≠m email...');

                // Re-autentifikace s aktu√°ln√≠m heslem
                const { reauthenticateWithCredential, EmailAuthProvider } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                await reauthenticateWithCredential(currentUser, credential);

                // Zmƒõna emailu v Auth
                const { updateEmail, sendEmailVerification } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                await updateEmail(currentUser, newEmail);

                // Voliteln√©: poslat ovƒõ≈ôovac√≠ email (pokud m√°≈° ovƒõ≈ôov√°n√≠ zapnut√©)
                try { await sendEmailVerification(currentUser); } catch (e) { /* noop */ }

                // Propsat zmƒõnu i do Firestore (root + profile)
                try {
                    const { setDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                    const uid = currentUser.uid;
                    await setDoc(doc(window.firebaseDb, 'users', uid), { email: newEmail }, { merge: true });
                    await setDoc(doc(window.firebaseDb, 'users', uid, 'profile', 'profile'), { email: newEmail, updatedAt: new Date() }, { merge: true });
                } catch (e) { /* noop */ }

                // Vyƒçistit formul√°≈ô
                const a = document.getElementById('newEmail'); if (a) a.value = '';
                const b = document.getElementById('confirmEmail'); if (b) b.value = '';
                const c = document.getElementById('currentPasswordForEmail'); if (c) c.value = '';

                // Propsat do UI emailu v osobn√≠ch informac√≠ch
                const emailInput = document.getElementById('email');
                if (emailInput) emailInput.value = newEmail;

                showMessage('‚úÖ Email byl √∫spƒõ≈°nƒõ zmƒõnƒõn!', 'success');
                console.log('‚úÖ Email √∫spƒõ≈°nƒõ zmƒõnƒõn');
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi zmƒõnƒõ emailu:', error);
                let errorMessage = 'Nepoda≈ôilo se zmƒõnit email';
                if (error?.code === 'auth/wrong-password') {
                    errorMessage = 'Souƒçasn√© heslo je nespr√°vn√©';
                } else if (error?.code === 'auth/invalid-email') {
                    errorMessage = 'Neplatn√Ω email';
                } else if (error?.code === 'auth/email-already-in-use') {
                    errorMessage = 'Tento email u≈æ je pou≈æ√≠v√°n jin√Ωm √∫ƒçtem';
                } else if (error?.code === 'auth/requires-recent-login') {
                    errorMessage = 'Pro zmƒõnu emailu se mus√≠te znovu p≈ôihl√°sit';
                }
                showMessage(errorMessage, 'error');
            }
        }

        // Zmƒõna hesla - DEFINICE HNED
        async function changePassword() {
            try {
                const currentUser = window.firebaseAuth.currentUser;
                if (!currentUser) {
                    showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni!', 'error');
                    return;
                }

                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                // Validace
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showMessage('Vypl≈àte v≈°echna pole!', 'error');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showMessage('Nov√° hesla se neshoduj√≠!', 'error');
                    return;
                }

                if (newPassword.length < 6) {
                    showMessage('Nov√© heslo mus√≠ m√≠t alespo≈à 6 znak≈Ø!', 'error');
                    return;
                }

                console.log('üîë Mƒõn√≠m heslo...');

                // Re-autentifikace s aktu√°ln√≠m heslem
                const { reauthenticateWithCredential, EmailAuthProvider } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                
                await reauthenticateWithCredential(currentUser, credential);

                // Zmƒõna hesla
                const { updatePassword } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                await updatePassword(currentUser, newPassword);

                // Vyƒçistit formul√°≈ô
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';

                showMessage('‚úÖ Heslo bylo √∫spƒõ≈°nƒõ zmƒõnƒõno!', 'success');
                console.log('‚úÖ Heslo √∫spƒõ≈°nƒõ zmƒõnƒõno');

            } catch (error) {
                console.error('‚ùå Chyba p≈ôi zmƒõnƒõ hesla:', error);
                
                let errorMessage = 'Nepoda≈ôilo se zmƒõnit heslo';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Souƒçasn√© heslo je nespr√°vn√©';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Nov√© heslo je p≈ô√≠li≈° slab√©';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Pro zmƒõnu hesla se mus√≠te znovu p≈ôihl√°sit';
                }
                
                showMessage(errorMessage, 'error');
            }
        }

        // Zobrazen√≠ zpr√°vy - DEFINICE HNED
        function showMessage(message, type = 'info') {
            // Odstranit existuj√≠c√≠ zpr√°vy
            const existingMessages = document.querySelectorAll('.message');
            existingMessages.forEach(msg => msg.remove());
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            // Stylov√°n√≠
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 2rem;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                min-width: 300px;
                font-size: 14px;
            `;
            
            if (type === 'success') {
                messageDiv.style.backgroundColor = '#28a745';
            } else if (type === 'error') {
                messageDiv.style.backgroundColor = '#dc3545';
            } else {
                messageDiv.style.backgroundColor = '#007bff';
            }
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    messageDiv.remove();
                }, 300);
            }, 4000);
        }

        // Delete account function
        async function deleteAccount() {
            // Vytvo≈ôit modal pro potvrzen√≠ smaz√°n√≠ √∫ƒçtu
            const deleteModal = document.createElement('div');
            deleteModal.className = 'modal';
            deleteModal.id = 'deleteAccountModal';
            deleteModal.style.display = 'flex';
            deleteModal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; width: 90%;">
                    <div class="modal-header" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(247, 124, 0, 0.1) 100%); border-bottom: 2px solid #EF4444;">
                        <h2 style="color: #EF4444; font-weight: 800; font-size: clamp(1.2rem, 4vw, 1.5rem);">‚ö†Ô∏è VAROV√ÅN√ç: NEVRATN√Å AKCE ‚ö†Ô∏è</h2>
                        <button class="close" onclick="closeDeleteModal()" style="font-size: 1.8rem; color: #6b7280;">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 2rem; max-height: 70vh; overflow-y: auto;">
                        <p style="font-size: clamp(1rem, 3vw, 1.1rem); font-weight: 600; color: #1a1a2e; margin-bottom: 1.5rem; line-height: 1.6;">
                            Opravdu chcete smazat sv≈Øj √∫ƒçet?
                        </p>
                        <p style="font-size: clamp(0.9rem, 2.5vw, 1rem); color: #EF4444; font-weight: 700; margin-bottom: 1rem;">
                            Tato akce je NEVRATN√Å a nelze ji vz√≠t zpƒõt!
                        </p>
                        <p style="font-size: clamp(0.9rem, 2.5vw, 1rem); color: #374151; margin-bottom: 1rem; line-height: 1.6;">
                            V≈°echna va≈°e data budou trvale smaz√°na:
                        </p>
                        <ul style="list-style: none; padding: 0; margin: 0 0 1.5rem 0;">
                            <li style="padding: 0.5rem 0; font-size: clamp(0.9rem, 2.5vw, 1rem); color: #4b5563; display: flex; align-items: start; gap: 0.5rem;">
                                <i class="fas fa-times-circle" style="color: #EF4444; margin-top: 0.2rem; flex-shrink: 0;"></i>
                                <span>V√°≈° profil a osobn√≠ informace</span>
                            </li>
                            <li style="padding: 0.5rem 0; font-size: clamp(0.9rem, 2.5vw, 1rem); color: #4b5563; display: flex; align-items: start; gap: 0.5rem;">
                                <i class="fas fa-times-circle" style="color: #EF4444; margin-top: 0.2rem; flex-shrink: 0;"></i>
                                <span>V≈°echny va≈°e inzer√°ty a slu≈æby</span>
                            </li>
                            <li style="padding: 0.5rem 0; font-size: clamp(0.9rem, 2.5vw, 1rem); color: #4b5563; display: flex; align-items: start; gap: 0.5rem;">
                                <i class="fas fa-times-circle" style="color: #EF4444; margin-top: 0.2rem; flex-shrink: 0;"></i>
                                <span>V≈°echny recenze a hodnocen√≠</span>
                            </li>
                            <li style="padding: 0.5rem 0; font-size: clamp(0.9rem, 2.5vw, 1rem); color: #4b5563; display: flex; align-items: start; gap: 0.5rem;">
                                <i class="fas fa-times-circle" style="color: #EF4444; margin-top: 0.2rem; flex-shrink: 0;"></i>
                                <span>V≈°echny zpr√°vy a konverzace</span>
                            </li>
                            <li style="padding: 0.5rem 0; font-size: clamp(0.9rem, 2.5vw, 1rem); color: #4b5563; display: flex; align-items: start; gap: 0.5rem;">
                                <i class="fas fa-times-circle" style="color: #EF4444; margin-top: 0.2rem; flex-shrink: 0;"></i>
                                <span>V≈°echna historick√° data</span>
                            </li>
                        </ul>
                        <div style="background: #FEF2F2; border-left: 4px solid #EF4444; padding: 1rem; margin-bottom: 1.5rem; border-radius: 8px;">
                            <p style="font-size: clamp(0.9rem, 2.5vw, 1rem); color: #991B1B; font-weight: 700; margin: 0; line-height: 1.5;">
                                PO PO≈Ω√ÅD√ÅN√ç O SMAZ√ÅN√ç NELZE POD√ÅVAT REKLAMACE!
                            </p>
                        </div>
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label for="deleteConfirmInput" style="display: block; font-size: clamp(0.9rem, 2.5vw, 1rem); font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                                Pro potvrzen√≠ zadejte p≈ôesnƒõ: <strong style="color: #EF4444;">smazat</strong>
                            </label>
                            <input type="text" id="deleteConfirmInput" class="form-input" placeholder="Zadejte: smazat" style="width: 100%; padding: 12px; font-size: clamp(0.9rem, 2.5vw, 1rem); border: 2px solid #e5e7eb; border-radius: 8px;">
                        </div>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: flex-end;">
                            <button onclick="closeDeleteModal()" class="btn-save" style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: clamp(0.9rem, 2.5vw, 1rem); font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                Zru≈°it
                            </button>
                            <button onclick="confirmDeleteAccount()" class="btn-danger" style="background: #EF4444; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: clamp(0.9rem, 2.5vw, 1rem); font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                Smazat √∫ƒçet
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(deleteModal);
            
            // Zamƒõ≈ôit input p≈ôi otev≈ôen√≠
            setTimeout(() => {
                const input = document.getElementById('deleteConfirmInput');
                if (input) input.focus();
            }, 100);
            
            // Zav≈ô√≠t p≈ôi kliknut√≠ na overlay
            deleteModal.addEventListener('click', (e) => {
                if (e.target === deleteModal) {
                    closeDeleteModal();
                }
            });
            
            // Zav≈ô√≠t p≈ôi stisknut√≠ Escape
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeDeleteModal();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        // Funkce pro zav≈ôen√≠ modalu
        function closeDeleteModal() {
            const modal = document.getElementById('deleteAccountModal');
            if (modal) {
                modal.style.animation = 'modalSlideOut 0.3s ease-out';
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        // Funkce pro fin√°ln√≠ potvrzen√≠ smaz√°n√≠
        async function confirmDeleteAccount() {
            const confirmInput = document.getElementById('deleteConfirmInput');
            if (!confirmInput || confirmInput.value.trim() !== 'smazat') {
                showMessage('‚ùå Nespr√°vn√© potvrzen√≠. Zadejte p≈ôesnƒõ: smazat', 'error');
                if (confirmInput) {
                    confirmInput.style.borderColor = '#EF4444';
                    confirmInput.focus();
                    setTimeout(() => {
                        confirmInput.style.borderColor = '#e5e7eb';
                    }, 2000);
                }
                return;
            }

            // Zav≈ô√≠t prvn√≠ modal a zobrazit fin√°ln√≠ potvrzen√≠
            closeDeleteModal();
            
            // Vytvo≈ôit fin√°ln√≠ potvrzovac√≠ modal s heslem
            const finalModal = document.createElement('div');
            finalModal.className = 'modal';
            finalModal.id = 'finalDeleteModal';
            finalModal.style.display = 'flex';
            finalModal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; width: 90%;">
                    <div class="modal-header" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(247, 124, 0, 0.15) 100%); border-bottom: 3px solid #EF4444;">
                        <h2 style="color: #EF4444; font-weight: 800; font-size: clamp(1.1rem, 3.5vw, 1.3rem);">üö® FIN√ÅLN√ç POTVRZEN√ç üö®</h2>
                        <button class="close" onclick="closeFinalDeleteModal()" style="font-size: 1.8rem; color: #6b7280;">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 2rem;">
                        <p style="font-size: clamp(1rem, 3vw, 1.1rem); font-weight: 600; color: #1a1a2e; margin-bottom: 1rem; line-height: 1.6;">
                            Opravdu chcete trvale smazat sv≈Øj √∫ƒçet?
                        </p>
                        <p style="font-size: clamp(0.9rem, 2.5vw, 1rem); color: #EF4444; font-weight: 700; margin-bottom: 1rem;">
                            Tato akce je NEVRATN√Å!
                        </p>
                        <p style="font-size: clamp(0.9rem, 2.5vw, 1rem); color: #374151; margin-bottom: 1.5rem; line-height: 1.6;">
                            V≈°echna va≈°e data budou nav≈ædy ztracena!
                        </p>
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label for="finalDeletePassword" style="display: block; font-size: clamp(0.9rem, 2.5vw, 1rem); font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                                Pro potvrzen√≠ zadejte va≈°e heslo:
                            </label>
                            <input type="password" id="finalDeletePassword" class="form-input" placeholder="Zadejte va≈°e heslo" style="width: 100%; padding: 12px; font-size: clamp(0.9rem, 2.5vw, 1rem); border: 2px solid #e5e7eb; border-radius: 8px;">
                        </div>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: flex-end;">
                            <button onclick="closeFinalDeleteModal()" class="btn-save" style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: clamp(0.9rem, 2.5vw, 1rem); font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                Zru≈°it
                            </button>
                            <button onclick="executeDeleteAccount()" class="btn-danger" style="background: #EF4444; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: clamp(0.9rem, 2.5vw, 1rem); font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                Ano, smazat √∫ƒçet
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(finalModal);
            
            // Zamƒõ≈ôit input pro heslo p≈ôi otev≈ôen√≠
            setTimeout(() => {
                const passwordInput = document.getElementById('finalDeletePassword');
                if (passwordInput) passwordInput.focus();
            }, 100);
            
            // Zav≈ô√≠t p≈ôi kliknut√≠ na overlay
            finalModal.addEventListener('click', (e) => {
                if (e.target === finalModal) {
                    closeFinalDeleteModal();
                }
            });
            
            // Zav≈ô√≠t p≈ôi stisknut√≠ Escape
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeFinalDeleteModal();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        // Funkce pro zav≈ôen√≠ fin√°ln√≠ho modalu
        function closeFinalDeleteModal() {
            const modal = document.getElementById('finalDeleteModal');
            if (modal) {
                modal.style.animation = 'modalSlideOut 0.3s ease-out';
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        // Funkce pro skuteƒçn√© smaz√°n√≠ √∫ƒçtu
        async function executeDeleteAccount() {
            try {
                const currentUser = window.firebaseAuth.currentUser;
                if (!currentUser) {
                    showMessage('‚ùå U≈æivatel nen√≠ p≈ôihl√°≈°en.', 'error');
                    return;
                }

                // Z√≠skat heslo z fin√°ln√≠ho modalu
                const passwordInput = document.getElementById('finalDeletePassword');
                const password = passwordInput ? passwordInput.value : '';
                
                if (!password) {
                    showMessage('‚ùå Pro smaz√°n√≠ √∫ƒçtu mus√≠te zadat va≈°e heslo.', 'error');
                    if (passwordInput) {
                        passwordInput.style.borderColor = '#EF4444';
                        passwordInput.focus();
                        setTimeout(() => {
                            passwordInput.style.borderColor = '#e5e7eb';
                        }, 2000);
                    }
                    return;
                }

                // Re-autentifikace p≈ôed smaz√°n√≠m √∫ƒçtu (vy≈æaduje Firebase)
                try {
                    const { reauthenticateWithCredential, EmailAuthProvider } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                    
                    if (!currentUser.email) {
                        showMessage('‚ùå Nelze prov√©st re-autentifikaci - chyb√≠ email.', 'error');
                        return;
                    }
                    
                    const credential = EmailAuthProvider.credential(currentUser.email, password);
                    await reauthenticateWithCredential(currentUser, credential);
                    console.log('‚úÖ Re-autentifikace √∫spƒõ≈°n√°');
                } catch (reauthError) {
                    console.error('‚ùå Chyba p≈ôi re-autentifikaci:', reauthError);
                    let errorMessage = 'Nespr√°vn√© heslo. Zkuste to znovu.';
                    if (reauthError?.code === 'auth/wrong-password') {
                        errorMessage = 'Nespr√°vn√© heslo. Zkuste to znovu.';
                    } else if (reauthError?.code === 'auth/invalid-credential') {
                        errorMessage = 'Neplatn√© p≈ôihla≈°ovac√≠ √∫daje. Zkuste to znovu.';
                    } else if (reauthError?.code === 'auth/user-mismatch') {
                        errorMessage = 'Chyba p≈ôi ovƒõ≈ôen√≠ identity. Zkuste to znovu.';
                    }
                    showMessage(errorMessage, 'error');
                    if (passwordInput) {
                        passwordInput.value = '';
                        passwordInput.focus();
                    }
                    return;
                }

                // Zav≈ô√≠t modal a zobrazit loading
                closeFinalDeleteModal();
                
                // Zobrazit loading modal
                const loadingModal = document.createElement('div');
                loadingModal.className = 'modal';
                loadingModal.id = 'deleteLoadingModal';
                loadingModal.style.display = 'flex';
                loadingModal.innerHTML = `
                    <div class="modal-content" style="max-width: 400px; width: 90%;">
                        <div class="modal-body" style="padding: 2rem; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">
                                <i class="fas fa-spinner fa-spin" style="color: #f77c00;"></i>
                            </div>
                            <p style="font-size: clamp(1rem, 3vw, 1.1rem); font-weight: 600; color: #1a1a2e; margin-bottom: 0.5rem;">
                                Ma≈æu v√°≈° √∫ƒçet...
                            </p>
                            <p style="font-size: clamp(0.9rem, 2.5vw, 1rem); color: #6b7280;">
                                Pros√≠m poƒçkejte
                            </p>
                        </div>
                    </div>
                `;
                document.body.appendChild(loadingModal);

                // Import Firebase functions
                const { 
                    deleteDoc, 
                    doc, 
                    collection, 
                    getDocs, 
                    query, 
                    where
                } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

                console.log('üóëÔ∏è Zaƒç√≠n√°m maz√°n√≠ √∫ƒçtu pro u≈æivatele:', currentUser.uid);

                // 1. Smazat profil u≈æivatele
                try {
                    await deleteDoc(doc(window.firebaseDb, 'users', currentUser.uid, 'profile', 'profile'));
                    console.log('‚úÖ Profil smaz√°n');
                } catch (error) {
                    console.log('‚ö†Ô∏è Profil nebyl nalezen nebo ji≈æ byl smaz√°n');
                }

                // 2. Smazat v≈°echny inzer√°ty u≈æivatele a jejich recenze
                try {
                    const adsCollection = collection(window.firebaseDb, 'users', currentUser.uid, 'inzeraty');
                    const adsSnapshot = await getDocs(adsCollection);
                    
                    // Pro ka≈æd√Ω inzer√°t smazat i jeho recenze
                    for (const adDoc of adsSnapshot.docs) {
                        try {
                            // Smazat recenze na inzer√°tu
                            const adReviewsRef = collection(window.firebaseDb, 'users', currentUser.uid, 'inzeraty', adDoc.id, 'reviews');
                            const adReviewsSnapshot = await getDocs(adReviewsRef);
                            const deleteAdReviewsPromises = adReviewsSnapshot.docs.map(reviewDoc => deleteDoc(reviewDoc.ref));
                            await Promise.all(deleteAdReviewsPromises);
                        } catch (error) {
                            console.log(`‚ö†Ô∏è Recenze na inzer√°tu ${adDoc.id} nebyly nalezeny`);
                        }
                        
                        // Smazat inzer√°t
                        await deleteDoc(adDoc.ref);
                    }
                    console.log('‚úÖ V≈°echny inzer√°ty a jejich recenze smaz√°ny');
                } catch (error) {
                    console.log('‚ö†Ô∏è Inzer√°ty nebyly nalezeny nebo ji≈æ byly smaz√°ny');
                }

                // 3. Smazat recenze na profilu u≈æivatele (users/{uid}/reviews)
                try {
                    const profileReviewsRef = collection(window.firebaseDb, 'users', currentUser.uid, 'reviews');
                    const profileReviewsSnapshot = await getDocs(profileReviewsRef);
                    const deleteProfileReviewsPromises = profileReviewsSnapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deleteProfileReviewsPromises);
                    console.log('‚úÖ Recenze na profilu smaz√°ny');
                } catch (error) {
                    console.log('‚ö†Ô∏è Recenze na profilu nebyly nalezeny');
                }

                // 4. Smazat v≈°echny recenze v root kolekci reviews (kde je reviewedUserId nebo reviewerId)
                try {
                    // Recenze kde je u≈æivatel recenzovan√Ω
                    const reviewedQuery = query(
                        collection(window.firebaseDb, 'reviews'),
                        where('reviewedUserId', '==', currentUser.uid)
                    );
                    const reviewedSnapshot = await getDocs(reviewedQuery);
                    const deleteReviewedPromises = reviewedSnapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deleteReviewedPromises);
                    
                    // Recenze kde je u≈æivatel recenzuj√≠c√≠
                    const reviewerQuery = query(
                        collection(window.firebaseDb, 'reviews'),
                        where('reviewerId', '==', currentUser.uid)
                    );
                    const reviewerSnapshot = await getDocs(reviewerQuery);
                    const deleteReviewerPromises = reviewerSnapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deleteReviewerPromises);
                    
                    console.log('‚úÖ V≈°echny recenze v root kolekci smaz√°ny');
                } catch (error) {
                    console.log('‚ö†Ô∏è Recenze v root kolekci nebyly nalezeny');
                }

                // 5. Smazat v≈°echny zpr√°vy (kde je userId nebo recipientId)
                try {
                    // Zpr√°vy kde je u≈æivatel odes√≠latel
                    const messagesFromQuery = query(
                        collection(window.firebaseDb, 'messages'),
                        where('userId', '==', currentUser.uid)
                    );
                    const messagesFromSnapshot = await getDocs(messagesFromQuery);
                    const deleteMessagesFromPromises = messagesFromSnapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deleteMessagesFromPromises);
                    
                    // Zpr√°vy kde je u≈æivatel p≈ô√≠jemce
                    const messagesToQuery = query(
                        collection(window.firebaseDb, 'messages'),
                        where('recipientId', '==', currentUser.uid)
                    );
                    const messagesToSnapshot = await getDocs(messagesToQuery);
                    const deleteMessagesToPromises = messagesToSnapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deleteMessagesToPromises);
                    
                    console.log('‚úÖ V≈°echny zpr√°vy smaz√°ny');
                } catch (error) {
                    console.log('‚ö†Ô∏è Zpr√°vy nebyly nalezeny');
                }

                // 6. Smazat v≈°echny konverzace (kde je u≈æivatel √∫ƒçastn√≠k)
                try {
                    const conversationsQuery = query(
                        collection(window.firebaseDb, 'conversations'),
                        where('participants', 'array-contains', currentUser.uid)
                    );
                    const conversationsSnapshot = await getDocs(conversationsQuery);
                    const deleteConversationsPromises = conversationsSnapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deleteConversationsPromises);
                    console.log('‚úÖ V≈°echny konverzace smaz√°ny');
                } catch (error) {
                    console.log('‚ö†Ô∏è Konverzace nebyly nalezeny');
                }

                // 7. Smazat hlavn√≠ dokument u≈æivatele (users/{uid})
                try {
                    await deleteDoc(doc(window.firebaseDb, 'users', currentUser.uid));
                    console.log('‚úÖ Hlavn√≠ dokument u≈æivatele smaz√°n');
                } catch (error) {
                    console.log('‚ö†Ô∏è Hlavn√≠ dokument u≈æivatele nebyl nalezen');
                }

                // 8. Smazat soubory ve Firebase Storage
                try {
                    const { getStorage, ref, listAll, deleteObject } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js');
                    const storage = getStorage(window.firebaseApp);
                    
                    // Smazat v≈°echny soubory v users/{uid}/
                    const userStorageRef = ref(storage, `users/${currentUser.uid}`);
                    try {
                        const filesList = await listAll(userStorageRef);
                        const deleteFilePromises = filesList.items.map(fileRef => deleteObject(fileRef));
                        await Promise.all(deleteFilePromises);
                        
                        // Smazat tak√© soubory v podslo≈æk√°ch
                        for (const prefixRef of filesList.prefixes) {
                            const prefixFiles = await listAll(prefixRef);
                            const deletePrefixPromises = prefixFiles.items.map(fileRef => deleteObject(fileRef));
                            await Promise.all(deletePrefixPromises);
                        }
                        console.log('‚úÖ V≈°echny soubory ve Storage smaz√°ny');
                    } catch (storageError) {
                        console.log('‚ö†Ô∏è Soubory ve Storage nebyly nalezeny nebo ji≈æ byly smaz√°ny');
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Chyba p≈ôi maz√°n√≠ soubor≈Ø ve Storage:', error);
                }

                // Delete Firebase Auth user (v Firebase v10+ se vol√° jako metoda na u≈æivateli)
                await currentUser.delete();
                console.log('‚úÖ Firebase Auth u≈æivatel smaz√°n');

                // Zav≈ô√≠t loading modal
                loadingModal.remove();

                // Zobrazit success modal
                const successModal = document.createElement('div');
                successModal.className = 'modal';
                successModal.id = 'deleteSuccessModal';
                successModal.style.display = 'flex';
                successModal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px; width: 90%;">
                        <div class="modal-header" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(247, 124, 0, 0.1) 100%); border-bottom: 3px solid #22C55E;">
                            <h2 style="color: #22C55E; font-weight: 800; font-size: clamp(1.1rem, 3.5vw, 1.3rem);">‚úÖ √öƒåET BYL √öSPƒö≈†Nƒö SMAZ√ÅN</h2>
                        </div>
                        <div class="modal-body" style="padding: 2rem; text-align: center;">
                            <div style="font-size: 4rem; margin-bottom: 1rem; color: #22C55E;">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <p style="font-size: clamp(1rem, 3vw, 1.1rem); color: #374151; margin-bottom: 1rem; line-height: 1.6;">
                                V√°≈° √∫ƒçet a v≈°echna souvisej√≠c√≠ data byla trvale smaz√°na.
                            </p>
                            <p style="font-size: clamp(0.9rem, 2.5vw, 1rem); color: #6b7280; margin-bottom: 1.5rem;">
                                Budete p≈ôesmƒõrov√°ni na hlavn√≠ str√°nku...
                            </p>
                        </div>
                    </div>
                `;
                document.body.appendChild(successModal);

                // Redirect to home page after 2 seconds
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);

            } catch (error) {
                console.error('‚ùå Chyba p≈ôi maz√°n√≠ √∫ƒçtu:', error);
                
                // Zav≈ô√≠t loading modal
                const loading = document.getElementById('deleteLoadingModal');
                if (loading) loading.remove();

                // Zobrazit error modal
                const errorModal = document.createElement('div');
                errorModal.className = 'modal';
                errorModal.id = 'deleteErrorModal';
                errorModal.style.display = 'flex';
                errorModal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px; width: 90%;">
                        <div class="modal-header" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(247, 124, 0, 0.1) 100%); border-bottom: 3px solid #EF4444;">
                            <h2 style="color: #EF4444; font-weight: 800; font-size: clamp(1.1rem, 3.5vw, 1.3rem);">‚ùå CHYBA P≈òI MAZ√ÅN√ç √öƒåTU</h2>
                            <button class="close" onclick="closeErrorModal()" style="font-size: 1.8rem; color: #6b7280;">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 2rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem; color: #EF4444; text-align: center;">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <p style="font-size: clamp(1rem, 3vw, 1.1rem); color: #374151; margin-bottom: 1rem; line-height: 1.6;">
                                Do≈°lo k chybƒõ p≈ôi maz√°n√≠ √∫ƒçtu:
                            </p>
                            <p style="font-size: clamp(0.9rem, 2.5vw, 1rem); color: #6b7280; margin-bottom: 1.5rem; background: #F3F4F6; padding: 1rem; border-radius: 8px; word-break: break-word;">
                                ${error.message || 'Nezn√°m√° chyba'}
                            </p>
                            <p style="font-size: clamp(0.9rem, 2.5vw, 1rem); color: #374151; margin-bottom: 1.5rem; line-height: 1.6;">
                                Pros√≠m kontaktujte podporu.
                            </p>
                            <div style="display: flex; justify-content: flex-end;">
                                <button onclick="closeErrorModal()" class="btn-save" style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: clamp(0.9rem, 2.5vw, 1rem); font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                    Zav≈ô√≠t
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(errorModal);
                
                // Zav≈ô√≠t p≈ôi kliknut√≠ na overlay
                errorModal.addEventListener('click', (e) => {
                    if (e.target === errorModal) {
                        closeErrorModal();
                    }
                });
            }
        }

        // Funkce pro zav≈ôen√≠ error modalu
        function closeErrorModal() {
            const modal = document.getElementById('deleteErrorModal');
            if (modal) {
                modal.style.animation = 'modalSlideOut 0.3s ease-out';
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        // EXPORT FUNKC√ç - HNED PO DEFINICI
        window.savePersonalInfo = savePersonalInfo;
        window.saveBusinessInfo = saveBusinessInfo;
        window.savePreferences = savePreferences;
        window.changeEmail = changeEmail;
        window.changeEmailAndPhone = changeEmailAndPhone;
        window.changePassword = changePassword;
        window.deleteAccount = deleteAccount;
        window.closeDeleteModal = closeDeleteModal;
        window.confirmDeleteAccount = confirmDeleteAccount;
        window.closeFinalDeleteModal = closeFinalDeleteModal;
        window.executeDeleteAccount = executeDeleteAccount;
        window.closeErrorModal = closeErrorModal;
        window.showMessage = showMessage;
        
        console.log('‚úÖ Funkce exportov√°ny:', {
            savePersonalInfo: typeof window.savePersonalInfo,
            saveBusinessInfo: typeof window.saveBusinessInfo,
            savePreferences: typeof window.savePreferences,
            changePassword: typeof window.changePassword
        });

        // Hlavn√≠ inicializaƒçn√≠ funkce
        async function initializeSettings() {
            try {
                // Zabr√°nit flickeru: osobn√≠/obchodn√≠ sekce skryjeme, dokud nezn√°me typ √∫ƒçtu
                const personal = document.getElementById('sectionPersonal');
                const business = document.getElementById('sectionBusiness');
                if (personal) personal.style.display = 'none';
                if (business) business.style.display = 'none';

                // Poƒçkat na Firebase
                await waitForFirebase();
                
                // Nav√°zat ovl√°d√°n√≠ profilov√© fotky
                setupProfilePhotoControls();
                
                // Naƒç√≠st data u≈æivatele (automaticky prefilled)
                await loadUserSettings();

                // Po prvn√≠m naƒçten√≠ nastaven√≠ hned naƒç√≠st i statistiky (aktivn√≠ inzer√°ty + hodnocen√≠)
                await loadUserData();
                
                // Nastavit real-time listener
                setupRealtimeListener();
                
                // Nastavit event listenery pro formul√°≈ôe
                setupFormListeners();
                
                // Automatick√© naƒç√≠t√°n√≠ dat p≈ôi r≈Øzn√Ωch ud√°lostech
                setupAutoRefresh();
                
                isInitialized = true;
                console.log('‚úÖ Nastaven√≠ profilu inicializov√°no s automatick√Ωm prefilled daty');
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi inicializaci:', error);
                showMessage('Chyba p≈ôi naƒç√≠t√°n√≠ nastaven√≠', 'error');
            }
        }

        // Nastaven√≠ automatick√©ho naƒç√≠t√°n√≠ dat
        function setupAutoRefresh() {
            // Automatick√© naƒç√≠t√°n√≠ p≈ôi focus na str√°nku
            window.addEventListener('focus', () => {
                if (isInitialized) {
                    console.log('üîÑ Automatick√© naƒç√≠t√°n√≠ dat p≈ôi focus');
                    loadUserSettings();
                    // Aktualizovat tak√© statistiky (aktivn√≠ inzer√°ty + hodnocen√≠)
                    loadUserData();
                }
            });

            // Automatick√© naƒç√≠t√°n√≠ p≈ôi n√°vratu na str√°nku (visibility change)
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && isInitialized) {
                    console.log('üîÑ Automatick√© naƒç√≠t√°n√≠ dat p≈ôi n√°vratu na str√°nku');
                    loadUserSettings();
                    loadUserData();
                }
            });

            // Automatick√© naƒç√≠t√°n√≠ p≈ôi zmƒõnƒõ auth stavu
            if (window.firebaseAuth) {
                window.firebaseAuth.onAuthStateChanged((user) => {
                    if (user && isInitialized) {
                        console.log('üîÑ Automatick√© naƒç√≠t√°n√≠ dat p≈ôi zmƒõnƒõ auth stavu');
                        loadUserSettings();
                        loadUserData();
                    }
                });
            }

            // Automatick√© naƒç√≠t√°n√≠ ka≈æd√Ωch 30 sekund (pokud je str√°nka aktivn√≠) - ODSTRANƒöNO
            // setInterval odstranƒõn, aby se formul√°≈ô neaktualizoval p≈ôi psan√≠
        }

        // Poƒçkat na Firebase
        async function waitForFirebase() {
            return new Promise((resolve, reject) => {
                const checkFirebase = setInterval(() => {
                    if (window.firebaseAuth && window.firebaseDb) {
                        clearInterval(checkFirebase);
                        resolve();
                    }
                }, 100);
                
                // Timeout po 10 sekund√°ch
                setTimeout(() => {
                    clearInterval(checkFirebase);
                    reject(new Error('Firebase se nenaƒçetl'));
                }, 10000);
            });
        }

        // Automatick√© naƒçten√≠ nastaven√≠ u≈æivatele
        async function loadUserSettings() {
            try {
                const currentUser = window.firebaseAuth.currentUser;
                if (!currentUser) {
                    console.log('‚ö†Ô∏è U≈æivatel nen√≠ p≈ôihl√°≈°en');
                    return;
                }

                console.log('üîÑ Automaticky naƒç√≠t√°m data pro u≈æivatele:', currentUser.uid);

                const { getDoc, doc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const profileRef = doc(window.firebaseDb, 'users', currentUser.uid, 'profile', 'profile');
                const profileSnap = await getDoc(profileRef);
                const rootRef = doc(window.firebaseDb, 'users', currentUser.uid);
                let rootUserType = '';
                let rootEmail = '';
                try {
                    const rootSnap = await getDoc(rootRef);
                    rootUserType = normalizeUserType(rootSnap.exists() ? (rootSnap.data()?.userType || rootSnap.data()?.type) : '');
                    rootEmail = rootSnap.exists() ? (rootSnap.data()?.email || '') : '';
                } catch (e) { /* noop */ }
                
                let userProfile = null;
                if (profileSnap.exists()) {
                    userProfile = profileSnap.data();
                    console.log('‚úÖ Automaticky naƒçten√Ω profil:', userProfile);
                } else {
                    // Pokud profil neexistuje, vytvo≈ôit z√°kladn√≠ strukturu s aktu√°ln√≠mi daty u≈æivatele
                    const displayName = currentUser.displayName || currentUser.email?.split('@')[0] || '';
                    const nameParts = displayName.split(' ');
                    
                    userProfile = {
                        userType: rootUserType || 'person',
                        firstName: nameParts[0] || '',
                        lastName: nameParts.slice(1).join(' ') || '',
                        name: displayName, // Zachovat slo≈æen√© jm√©no pro kompatibilitu
                        email: currentUser.email || '',
                        phone: '',
                        city: '',
                        bio: '',
                        businessName: '',
                        businessType: '',
                        businessIco: '',
                        businessDic: '',
                        businessAddress: '',
                        businessWebsite: '',
                        businessDescription: '',
                        emailNotifications: true,
                        smsNotifications: false,
                        marketingEmails: false,
                        createdAt: new Date()
                    };
                    
                    // Ulo≈æit z√°kladn√≠ profil
                    await setDoc(profileRef, userProfile, { merge: true });
                    console.log('‚úÖ Automaticky vytvo≈ôen z√°kladn√≠ profil:', userProfile);
                }

                // Email fallback: nƒõkdy je v root users/{uid} nebo jen v Auth profilu
                const resolvedEmail = (userProfile?.email || '').toString().trim() || (currentUser.email || '').toString().trim() || (rootEmail || '').toString().trim();
                if (userProfile && (!userProfile.email || !String(userProfile.email).trim()) && resolvedEmail) {
                    try { await setDoc(profileRef, { email: resolvedEmail }, { merge: true }); } catch (e) { /* noop */ }
                    // udr≈æet i v pamƒõti pro updateFormFields
                    try { userProfile.email = resolvedEmail; } catch (e) { /* noop */ }
                }

                // Ulo≈æit/propagovat userType do UI (Hobby vs Firma)
                const resolvedType = normalizeUserType(userProfile?.userType || userProfile?.type) || rootUserType || 'person';
                window.__profileUserType = resolvedType;
                applyUserTypeToSettingsUI(resolvedType);
                if (userProfile && normalizeUserType(userProfile.userType) !== resolvedType) {
                    try { await setDoc(profileRef, { userType: resolvedType }, { merge: true }); } catch (e) { /* noop */ }
                }

                // Automaticky aktualizovat formul√°≈ô s daty (v≈ædy prefilled)
                updateFormFields(userProfile);
                
                // Tich√° notifikace o √∫spƒõ≈°n√©m naƒçten√≠ (pouze p≈ôi prvn√≠m naƒçten√≠)
                if (!window.dataLoaded) {
                    console.log('‚úÖ Data automaticky naƒçtena a formul√°≈ô prefilled');
                    window.dataLoaded = true;
                }
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi automatick√©m naƒç√≠t√°n√≠ nastaven√≠:', error);
                // Tich√° chyba - neobtƒõ≈æovat u≈æivatele notifikacemi
            }
        }

        // Real-time listener pro zmƒõny v profilu
        function setupRealtimeListener() {
            try {
                const currentUser = window.firebaseAuth.currentUser;
                if (!currentUser) return;

                const { onSnapshot, doc } = import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                onSnapshot.then(({ onSnapshot }) => {
                    const profileRef = doc(window.firebaseDb, 'users', currentUser.uid, 'profile', 'profile');
                    
                    profileListener = onSnapshot(profileRef, (snapshot) => {
                        if (snapshot.exists()) {
                            const userProfile = snapshot.data();
                            console.log('üîÑ Real-time aktualizace profilu:', userProfile);
                            
                            // Aktualizovat pouze pokud u≈æivatel neupravuje formul√°≈ô
                            const activeElement = document.activeElement;
                            const isEditing = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA' || activeElement.tagName === 'SELECT');
                            
                            // Neaktualizovat, pokud u≈æivatel pr√°vƒõ upravuje formul√°≈ô nebo m√° upraven√° pole
                            if (!isEditing && !isUserEditing && editedFields.size === 0) {
                                updateFormFields(userProfile);
                            }
                        }
                    }, (error) => {
                        console.error('‚ùå Chyba real-time listeneru:', error);
                    });
                });
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi nastaven√≠ real-time listeneru:', error);
            }
        }

        // Nastaven√≠ event listener≈Ø pro formul√°≈ôe
        function setupFormListeners() {
            // Sledovat, kdy u≈æivatel zaƒç√≠n√° upravovat pole
            const formElements = document.querySelectorAll('input, textarea, select');
            formElements.forEach(element => {
                element.addEventListener('focus', () => {
                    isUserEditing = true;
                });
                
                element.addEventListener('input', () => {
                    isUserEditing = true;
                    editedFields.add(element.id);
                });
                
                element.addEventListener('blur', () => {
                    // Poƒçkat chv√≠li, ne≈æ se resetuje flag (pro p≈ô√≠pad, ≈æe u≈æivatel p≈ôepne na jin√© pole)
                    setTimeout(() => {
                        const activeElement = document.activeElement;
                        const stillEditing = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA' || activeElement.tagName === 'SELECT');
                        if (!stillEditing) {
                            isUserEditing = false;
                        }
                    }, 100);
                });
            });
            // Auto-save p≈ôi zmƒõnƒõ hodnot (s debounce)
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                let timeout;
                input.addEventListener('input', () => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        // Oznaƒçit, ≈æe byly provedeny zmƒõny
                        input.classList.add('modified');
                    }, 500);
                });
            });
            
            // Speci√°ln√≠ kontrola pro telefon - zabr√°nit √∫pln√©mu smaz√°n√≠
            const phoneEl = document.getElementById('phone');
            if (phoneEl) {
                // Kontrola p≈ôi zmƒõnƒõ hodnoty
                phoneEl.addEventListener('input', function() {
                    const value = this.value.trim();
                    // Pokud je pole pr√°zdn√© nebo obsahuje jen p≈ôedvolbu bez ƒç√≠sla, obnovit minim√°ln√≠ hodnotu
                    if (!value || value === '+' || value === '420') {
                        this.value = '+420';
                        return;
                    }
                    
                    // Pokud u≈æivatel sma≈æe v≈°echno, obnovit p≈ôedvolbu
                    if (value.length === 0) {
                        this.value = '+420';
                        return;
                    }
                    
                    // Zkontrolovat, zda obsahuje alespo≈à nƒõjak√© ƒç√≠slo (kromƒõ p≈ôedvolby)
                    const withoutPrefix = value.replace(/^\+420\s*/, '').replace(/^420\s*/, '').replace(/\s+/g, '');
                    if (withoutPrefix.length === 0) {
                        // Pokud nen√≠ ≈æ√°dn√© ƒç√≠slo, ponechat alespo≈à p≈ôedvolbu
                        if (!value.startsWith('+420') && !value.startsWith('420')) {
                            this.value = '+420';
                        }
                    }
                });
                
                // Kontrola p≈ôi ztr√°tƒõ fokusu (blur)
                phoneEl.addEventListener('blur', function() {
                    const value = this.value.trim();
                    // Pokud je pole pr√°zdn√© nebo obsahuje jen p≈ôedvolbu bez ƒç√≠sla, obnovit minim√°ln√≠ hodnotu
                    if (!value || value === '+' || value === '420' || value === '+420') {
                        this.value = '+420';
                    } else {
                        // Zkontrolovat, zda obsahuje alespo≈à nƒõjak√© ƒç√≠slo
                        const withoutPrefix = value.replace(/^\+420\s*/, '').replace(/^420\s*/, '').replace(/\s+/g, '');
                        const hasNumbers = /\d/.test(withoutPrefix);
                        if (!hasNumbers || withoutPrefix.length === 0) {
                            this.value = '+420';
                        }
                    }
                });
            }
        }

        // Aktualizace formul√°≈ôov√Ωch pol√≠ s daty (v≈ædy prefilled kromƒõ hesel)
        function updateFormFields(userProfile) {
            console.log('üîÑ Aktualizuji formul√°≈ô s daty:', userProfile);

            // Aplikovat viditelnost sekc√≠ podle typu √∫ƒçtu (Hobby vs Firma)
            const resolvedType = normalizeUserType(userProfile?.userType || userProfile?.type) || normalizeUserType(window.__profileUserType) || 'person';
            window.__profileUserType = resolvedType;
            applyUserTypeToSettingsUI(resolvedType);
            
            // Osobn√≠ informace - v≈ædy prefilled (bez emailu a telefonu)
            const personalFields = {
                'firstName': userProfile?.firstName || '',
                'lastName': userProfile?.lastName || '',
                'city': userProfile?.city || '',
                'bio': userProfile?.bio || ''
            };

            Object.entries(personalFields).forEach(([fieldId, value]) => {
                const element = document.getElementById(fieldId);
                if (element) {
                    // Neaktualizovat pole, kter√° u≈æivatel pr√°vƒõ upravuje nebo kter√° maj√≠ zmƒõnƒõnou hodnotu
                    const isCurrentlyEditing = document.activeElement === element;
                    const wasEdited = editedFields.has(fieldId);
                    const currentValue = element.value.trim();
                    const newValue = (value || '').toString().trim();
                    
                    // Aktualizovat pouze pokud pole nen√≠ pr√°vƒõ upravov√°no a hodnota se zmƒõnila
                    if (!isCurrentlyEditing && !wasEdited && currentValue !== newValue) {
                        element.value = value;
                        element.placeholder = value ? `Aktu√°ln√≠: ${value}` : 'Zadejte hodnotu';
                    } else if (!value && !currentValue) {
                        // Pokud je pole pr√°zdn√© a nov√° hodnota je tak√© pr√°zdn√°, aktualizovat placeholder
                        element.placeholder = 'Zadejte hodnotu';
                    }
                }
            });

            // Zobrazit aktu√°ln√≠ email a telefon v sekci "Zmƒõna emailu a telefonn√≠ho ƒç√≠sla"
            const authEmail = (window.firebaseAuth?.currentUser?.email || '').toString().trim();
            const profileEmail = (userProfile?.email || '').toString().trim();
            const emailValue = profileEmail || authEmail || '';
            
            // Telefon se bere z profilu a form√°tuje se pro zobrazen√≠
            let phoneValue = userProfile?.phone || '';
            if (phoneValue && phoneValue.startsWith('+420') && phoneValue.length > 4) {
                const digits = phoneValue.slice(4).replace(/\D/g, '');
                if (digits.length >= 9) {
                    // Form√°tovat jako +420 XXX XXX XXX
                    const formatted = `+420 ${digits.slice(0, 3)} ${digits.slice(3, 6)} ${digits.slice(6)}`.trim();
                    phoneValue = formatted;
                }
            }
            
            // Aktualizovat zobrazen√≠ aktu√°ln√≠ch hodnot
            const currentEmailDisplay = document.getElementById('currentEmailDisplay');
            const currentPhoneDisplay = document.getElementById('currentPhoneDisplay');
            if (currentEmailDisplay) {
                currentEmailDisplay.textContent = emailValue || 'Nen√≠ nastaven';
            }
            if (currentPhoneDisplay) {
                currentPhoneDisplay.textContent = phoneValue || 'Nen√≠ nastaven';
            }
            
            // Profilov√° fotka ‚Äì n√°hled
            try {
                const STOCK_AVATAR_URL = 'data:image/svg+xml;base64,' + btoa('<svg width="128" height="128" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="avatarGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#f77c00;stop-opacity:1" /><stop offset="100%" style="stop-color:#fdf002;stop-opacity:1" /></linearGradient></defs><circle cx="64" cy="64" r="64" fill="url(#avatarGradient)"/><circle cx="64" cy="48" r="16" fill="white"/><path d="M32 88C32 80.268 38.268 74 46 74H82C89.732 74 96 80.268 96 88V128H32V88Z" fill="white"/></svg>');
                const url = userProfile?.photoURL || userProfile?.avatarUrl || STOCK_AVATAR_URL;
                const img = document.getElementById('profilePhotoPreview');
                const ph = document.getElementById('profilePhotoPlaceholder');
                if (img && ph) {
                    img.src = url;
                    img.style.display = 'block';
                    ph.style.display = 'none';
                    // Reaplikovat avatar i do sidebaru (pro zav≈ôen√Ω stav)
                    if (typeof window.applySidebarAvatar === 'function') {
                        window.applySidebarAvatar(url === STOCK_AVATAR_URL ? '' : url);
                    }
                }
            } catch (e) { /* noop */ }

            // Obchodn√≠ informace - v≈ædy prefilled
            // Naƒç√≠st z hlavn√≠ √∫rovnƒõ profilu, nebo z company objektu (pro zpƒõtnou kompatibilitu)
            const company = userProfile?.company || {};
            const businessFields = {
                'businessName': userProfile?.businessName || company?.companyName || '',
                'businessType': userProfile?.businessType || '',
                'businessIco': userProfile?.businessIco || company?.ico || '',
                'businessDic': userProfile?.businessDic || company?.dic || '',
                'businessAddress': userProfile?.businessAddress || company?.address || '',
                'businessWebsite': userProfile?.businessWebsite || company?.website || '',
                'businessDescription': userProfile?.businessDescription || ''
            };

            Object.entries(businessFields).forEach(([fieldId, value]) => {
                const element = document.getElementById(fieldId);
                if (element) {
                    // Neaktualizovat pole, kter√° u≈æivatel pr√°vƒõ upravuje nebo kter√° maj√≠ zmƒõnƒõnou hodnotu
                    const isCurrentlyEditing = document.activeElement === element;
                    const wasEdited = editedFields.has(fieldId);
                    const currentValue = element.value.trim();
                    const newValue = (value || '').toString().trim();
                    
                    // Aktualizovat pouze pokud pole nen√≠ pr√°vƒõ upravov√°no a hodnota se zmƒõnila
                    if (!isCurrentlyEditing && !wasEdited && currentValue !== newValue) {
                        element.value = value;
                        element.placeholder = value ? `Aktu√°ln√≠: ${value}` : 'Zadejte hodnotu';
                    } else if (!value && !currentValue) {
                        // Pokud je pole pr√°zdn√© a nov√° hodnota je tak√© pr√°zdn√°, aktualizovat placeholder
                        element.placeholder = 'Zadejte hodnotu';
                    }
                }
            });

            // P≈ôedvolby upozornƒõn√≠ - v≈ædy prefilled
            const preferenceFields = {
                'chatNotifications': userProfile?.chatNotifications !== false,
            };

            Object.entries(preferenceFields).forEach(([fieldId, value]) => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.checked = value;
                }
            });
            
            // Hesla - NIKDY neprefilled (z≈Øst√°vaj√≠ pr√°zdn√°)
            const passwordFields = ['currentPassword', 'newPassword', 'confirmPassword'];
            passwordFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.value = ''; // V≈ædy pr√°zdn√©
                    element.placeholder = 'Zadejte heslo';
                }
            });
            
            console.log('‚úÖ Formul√°≈ô aktualizov√°n s prefilled daty (kromƒõ hesel)');
        }

        // ===== UserType helpers (Hobby vs Firma) =====
        function normalizeUserType(value) {
            const t = (value || '').toString().trim().toLowerCase();
            if (t === 'company' || t === 'firma' || t === 'business') return 'company';
            if (t === 'person' || t === 'hobby' || t === 'personal') return 'person';
            return '';
        }

        function applyUserTypeToSettingsUI(userType) {
            const t = normalizeUserType(userType) || 'person';
            const isCompany = t === 'company';
            const personal = document.getElementById('sectionPersonal');
            const business = document.getElementById('sectionBusiness');
            if (personal) personal.style.display = isCompany ? 'none' : '';
            if (business) business.style.display = isCompany ? '' : 'none';
        }
        
        // ===== Profilov√° fotka (UI + upload) =====
        function setupProfilePhotoControls() {
            const fileInput = document.getElementById('profilePhotoInput');
            const preview = document.getElementById('profilePhotoPreview');
            const placeholder = document.getElementById('profilePhotoPlaceholder');
            const btnUpload = document.getElementById('btnUploadProfilePhoto');
            const btnRemove = document.getElementById('btnRemoveProfilePhoto');
            
            if (fileInput) {
                fileInput.addEventListener('change', () => {
                    const file = fileInput.files && fileInput.files[0];
                    if (!file) return;
                    // Otev≈ô√≠t o≈ôezov√© okno
                    openAvatarCrop(file);
                });
            }
            
            if (btnUpload) {
                btnUpload.addEventListener('click', uploadProfilePhoto);
            }
            if (btnRemove) {
                btnRemove.addEventListener('click', removeProfilePhoto);
            }
        }
        
        // Stav pro o≈ôez
        let __avatarCrop = {
            file: null,
            objectUrl: '',
            imgEl: null,
            areaEl: null,
            zoomEl: null,
            baseScale: 1,
            scale: 1,
            offsetX: 0,
            offsetY: 0,
            naturalWidth: 0,
            naturalHeight: 0
        };
        let __avatarBlob = null; // v√Ωsledn√Ω o≈ô√≠znut√Ω blob (pou≈æije se p≈ôi nahr√°n√≠)
        
        function openAvatarCrop(file) {
            try {
                __avatarBlob = null;
                __avatarCrop.file = file;
                // P≈ôipravit modal
                let modal = document.getElementById('avatarCropModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'avatarCropModal';
                    modal.className = 'modal';
                    modal.style.display = 'none';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 540px;">
                            <div class="modal-header">
                                <h2 style="margin:0;">O≈ô√≠znout fotku</h2>
                                <span class="close" onclick="closeAvatarCrop()">&times;</span>
                            </div>
                            <div class="modal-body" style="padding: 1rem;">
                                <div id="cropArea" style="width:320px;height:320px;margin:0 auto;position:relative;overflow:hidden;background:#f3f4f6;border-radius:12px;border:1px solid #e5e7eb;">
                                    <img id="cropImage" alt="Crop" style="position:absolute; left:0; top:0; transform-origin: top left; user-select:none; -webkit-user-drag:none;">
                                </div>
                                <div style="margin-top:12px;">
                                    <input id="cropZoom" type="range" min="1" max="3" step="0.01" value="1" style="width:100%;">
                                </div>
                            </div>
                            <div class="modal-actions" style="display:flex; gap:8px; justify-content:flex-end; padding: 0 1rem 1rem;">
                                <button class="btn-save" onclick="confirmAvatarCrop()">
                                    <i class="fas fa-check"></i> Potvrdit
                                </button>
                                <button class="btn-save" onclick="closeAvatarCrop()" style="background:#fff; border:1px solid #e5e7eb; color:#6b7280;">
                                    Zru≈°it
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                
                const area = modal.querySelector('#cropArea');
                const img = modal.querySelector('#cropImage');
                const zoom = modal.querySelector('#cropZoom');
                
                // Naplnit stav
                __avatarCrop.areaEl = area;
                __avatarCrop.imgEl = img;
                __avatarCrop.zoomEl = zoom;
                
                // Naƒç√≠st obr√°zek
                if (__avatarCrop.objectUrl) URL.revokeObjectURL(__avatarCrop.objectUrl);
                __avatarCrop.objectUrl = URL.createObjectURL(file);
                img.src = __avatarCrop.objectUrl;
                img.onload = () => {
                    const aw = area.clientWidth;
                    const ah = area.clientHeight;
                    const iw = img.naturalWidth;
                    const ih = img.naturalHeight;
                    __avatarCrop.naturalWidth = iw;
                    __avatarCrop.naturalHeight = ih;
                    // Fit-cover pro ƒçtverec
                    const scale = Math.max(aw / iw, ah / ih);
                    __avatarCrop.baseScale = scale;
                    __avatarCrop.scale = scale;
                    __avatarCrop.offsetX = (aw - iw * scale) / 2;
                    __avatarCrop.offsetY = (ah - ih * scale) / 2;
                    applyCropTransform();
                };
                
                // Drag to move
                let dragging = false;
                let startX = 0, startY = 0, initX = 0, initY = 0;
                const startDrag = (e) => {
                    dragging = true;
                    const p = e.touches ? e.touches[0] : e;
                    startX = p.clientX;
                    startY = p.clientY;
                    initX = __avatarCrop.offsetX;
                    initY = __avatarCrop.offsetY;
                    e.preventDefault();
                };
                const onDrag = (e) => {
                    if (!dragging) return;
                    const p = e.touches ? e.touches[0] : e;
                    const dx = p.clientX - startX;
                    const dy = p.clientY - startY;
                    __avatarCrop.offsetX = initX + dx;
                    __avatarCrop.offsetY = initY + dy;
                    clampOffsets();
                    applyCropTransform();
                    e.preventDefault();
                };
                const endDrag = () => { dragging = false; };
                img.onpointerdown = startDrag;
                img.onpointermove = onDrag;
                img.onpointerup = endDrag;
                img.onpointercancel = endDrag;
                img.ontouchstart = startDrag;
                img.ontouchmove = onDrag;
                img.ontouchend = endDrag;
                
                // Zoom
                zoom.oninput = () => {
                    __avatarCrop.scale = __avatarCrop.baseScale * parseFloat(zoom.value || '1');
                    clampOffsets();
                    applyCropTransform();
                };
                
                modal.style.display = 'flex';
            } catch (e) {
                console.error('openAvatarCrop error', e);
                showMessage('Nepoda≈ôilo se otev≈ô√≠t o≈ôez fotky', 'error');
            }
        }
        
        function closeAvatarCrop() {
            const modal = document.getElementById('avatarCropModal');
            if (modal) modal.style.display = 'none';
            if (__avatarCrop.objectUrl) {
                URL.revokeObjectURL(__avatarCrop.objectUrl);
                __avatarCrop.objectUrl = '';
            }
        }
        
        function clampOffsets() {
            const aw = __avatarCrop.areaEl?.clientWidth || 320;
            const ah = __avatarCrop.areaEl?.clientHeight || 320;
            const w = __avatarCrop.naturalWidth * __avatarCrop.scale;
            const h = __avatarCrop.naturalHeight * __avatarCrop.scale;
            // Zajistit, aby obraz pokr√Ωval v√Ω≈ôez ‚Äì tzn. horn√≠/lev√Ω offset nesm√≠ b√Ωt vƒõt≈°√≠ ne≈æ 0
            // a prav√Ω/doln√≠ nesm√≠ ‚Äûodjet‚Äú (offset >= aw - w, ah - h)
            const minX = Math.min(0, aw - w);
            const minY = Math.min(0, ah - h);
            const maxX = Math.max(0, aw - w);
            const maxY = Math.max(0, ah - h);
            __avatarCrop.offsetX = Math.min(Math.max(__avatarCrop.offsetX, minX), maxX);
            __avatarCrop.offsetY = Math.min(Math.max(__avatarCrop.offsetY, minY), maxY);
        }
        
        function applyCropTransform() {
            const img = __avatarCrop.imgEl;
            if (!img) return;
            img.style.transform = `translate(${__avatarCrop.offsetX}px, ${__avatarCrop.offsetY}px) scale(${__avatarCrop.scale})`;
        }
        
        async function confirmAvatarCrop() {
            try {
                const aw = __avatarCrop.areaEl?.clientWidth || 320;
                const ah = __avatarCrop.areaEl?.clientHeight || 320;
                const scale = __avatarCrop.scale;
                const iw = __avatarCrop.naturalWidth;
                const ih = __avatarCrop.naturalHeight;
                const ox = __avatarCrop.offsetX;
                const oy = __avatarCrop.offsetY;
                
                // V√Ωpoƒçet zdrojov√©ho v√Ω≈ôezu
                const sx = Math.max(0, -ox / scale);
                const sy = Math.max(0, -oy / scale);
                const sWidth = Math.min(iw, aw / scale);
                const sHeight = Math.min(ih, ah / scale);
                
                const size = 512; // export 512x512
                const canvas = document.createElement('canvas');
                canvas.width = size; canvas.height = size;
                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingQuality = 'high';
                const img = __avatarCrop.imgEl;
                await new Promise(r => setTimeout(r, 0)); // yield
                ctx.drawImage(img, sx, sy, sWidth, sHeight, 0, 0, size, size);
                
                // Blob (preferuj webp, fallback jpeg)
                const toBlob = (type) => new Promise((resolve) => canvas.toBlob(resolve, type, 0.92));
                __avatarBlob = await toBlob('image/webp') || await toBlob('image/jpeg');
                
                // N√°hled do UI
                const preview = document.getElementById('profilePhotoPreview');
                const placeholder = document.getElementById('profilePhotoPlaceholder');
                if (__avatarBlob && preview && placeholder) {
                    const url = URL.createObjectURL(__avatarBlob);
                    preview.src = url;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                }
                closeAvatarCrop();
                showMessage('N√°hled o≈ôezu p≈ôipraven. Kliknƒõte na Nahr√°t.', 'success');
            } catch (e) {
                console.error('confirmAvatarCrop error', e);
                showMessage('Nepoda≈ôilo se o≈ô√≠znout fotku', 'error');
            }
        }
        window.confirmAvatarCrop = confirmAvatarCrop;
        window.closeAvatarCrop = closeAvatarCrop;
        
        async function uploadProfilePhoto() {
            try {
                if (!window.firebaseAuth || !window.firebaseDb) return showMessage('Firebase nen√≠ inicializov√°n', 'error');
                const user = window.firebaseAuth.currentUser;
                if (!user) return showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni', 'error');
                
                const fileInput = document.getElementById('profilePhotoInput');
                const pickedFile = fileInput?.files && fileInput.files[0];
                if (!pickedFile && !__avatarBlob) return showMessage('Vyberte pros√≠m obr√°zek', 'error');
                
                // Naƒçti Firebase Storage dynamicky
                const { getStorage, ref, uploadBytes, getDownloadURL } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js');
                const storage = getStorage(window.firebaseApp);
                
                // C√≠l v √∫lo≈æi≈°ti
                const ext = __avatarBlob ? 'webp' : (pickedFile.name.split('.').pop() || 'jpg').toLowerCase();
                // Pozn.: ukl√°d√°me pod /services/{uid}/profile/‚Ä¶ aby vyhovƒõlo aktu√°ln√≠m Storage Rules
                const path = `services/${user.uid}/profile/avatar_${Date.now()}.${ext}`;
                const storageRef = ref(storage, path);
                
                // Nahr√°t
                const dataToUpload = __avatarBlob || pickedFile;
                await uploadBytes(storageRef, dataToUpload, { contentType: __avatarBlob ? (__avatarBlob.type || 'image/webp') : pickedFile.type });
                const publicUrl = await getDownloadURL(storageRef);
                
                // Ulo≈æit do Firestore
                const { setDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                await setDoc(doc(window.firebaseDb, 'users', user.uid, 'profile', 'profile'), {
                    photoURL: publicUrl,
                    avatarUpdatedAt: new Date()
                }, { merge: true });
                
                showMessage('‚úÖ Profilov√° fotka nahr√°na', 'success');
                
                // Reset inputu a aktualizace n√°hledu
                fileInput.value = '';
                const img = document.getElementById('profilePhotoPreview');
                if (img) img.src = publicUrl;
                __avatarBlob = null;
                
            } catch (e) {
                console.error('uploadProfilePhoto error', e);
                showMessage('Nepoda≈ôilo se nahr√°t fotku: ' + (e?.message || e), 'error');
            }
        }
        
        async function removeProfilePhoto() {
            try {
                if (!window.firebaseAuth || !window.firebaseDb) return;
                const user = window.firebaseAuth.currentUser;
                if (!user) return showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni', 'error');
                
                // Smazat odkaz ve Firestore (soubor ve Storage ponech√°me ‚Äì m≈Ø≈æe b√Ωt sd√≠len)
                const { setDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                await setDoc(doc(window.firebaseDb, 'users', user.uid, 'profile', 'profile'), {
                    photoURL: '',
                    avatarUpdatedAt: new Date()
                }, { merge: true });
                
                // UI reset
                const img = document.getElementById('profilePhotoPreview');
                const ph = document.getElementById('profilePhotoPlaceholder');
                if (img && ph) {
                    img.src = '';
                    img.style.display = 'none';
                    ph.style.display = 'block';
                }
                
                showMessage('‚úÖ Profilov√° fotka odebr√°na', 'success');
            } catch (e) {
                console.error('removeProfilePhoto error', e);
                showMessage('Nepoda≈ôilo se odebrat fotku', 'error');
            }
        }

        // Ulo≈æen√≠ upozornƒõn√≠
        async function saveNotifications() {
            console.log('üöÄ saveNotifications vol√°na!');
            try {
                const currentUser = window.firebaseAuth.currentUser;
                if (!currentUser) {
                    showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni!', 'error');
                    return;
                }

                const chatNotificationsEl = document.getElementById('chatNotifications');
                
                const notificationsData = {
                    chatNotifications: chatNotificationsEl ? chatNotificationsEl.checked : true,
                    updatedAt: new Date()
                };

                console.log('üíæ Ukl√°d√°m upozornƒõn√≠:', notificationsData);

                const { setDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const profileRef = doc(window.firebaseDb, 'users', currentUser.uid, 'profile', 'profile');
                
                await setDoc(profileRef, notificationsData, { merge: true });

                console.log('‚úÖ Upozornƒõn√≠ √∫spƒõ≈°nƒõ ulo≈æena');
                showMessage('‚úÖ Nastaven√≠ upozornƒõn√≠ bylo ulo≈æeno!', 'success');

            } catch (error) {
                console.error('‚ùå Chyba p≈ôi ukl√°d√°n√≠ upozornƒõn√≠:', error);
                showMessage('Nepoda≈ôilo se ulo≈æit upozornƒõn√≠: ' + error.message, 'error');
            }
        }
        window.saveNotifications = saveNotifications;

        // CSS pro animace a toggle switch
        const settingsStyle = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .modified {
                border-color: #007bff !important;
                box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25) !important;
            }
            /* Toggle Switch */
            .switch input:checked + .slider {
                background: linear-gradient(135deg, #ff6a00 0%, #ffa62b 100%);
            }
            .switch .slider:before {
                content: "";
                position: absolute;
                height: 22px;
                width: 22px;
                left: 3px;
                bottom: 3px;
                background-color: white;
                transition: .3s;
                border-radius: 50%;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }
            .switch input:checked + .slider:before {
                transform: translateX(22px);
            }
        `;
        document.head.appendChild(settingsStyle);

        // Cleanup p≈ôi opu≈°tƒõn√≠ str√°nky
        window.addEventListener('beforeunload', () => {
            if (profileListener) {
                profileListener();
            }
        });

        // Load actual user data
        async function loadUserData() {
            console.log('üíæ Loading user data...');
            try {
                const currentUser = window.firebaseAuth.currentUser;
                if (!currentUser) {
                    console.log('‚ö†Ô∏è U≈æivatel nen√≠ p≈ôihl√°≈°en');
                    return;
                }

                console.log('üë§ Naƒç√≠t√°m data pro u≈æivatele:', currentUser.uid);

                // Load user profile from Firestore
                const { getDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const profileRef = doc(window.firebaseDb, 'users', currentUser.uid, 'profile', 'profile');
                const profileSnap = await getDoc(profileRef);
                
                let userProfile = null;
                if (profileSnap.exists()) {
                    userProfile = profileSnap.data();
                }

                // Load user ads to get statistics
                const { getDocs, collection } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const adsRef = collection(window.firebaseDb, 'users', currentUser.uid, 'inzeraty');
                const adsSnapshot = await getDocs(adsRef);
                
                const userAds = [];
                adsSnapshot.forEach((doc) => {
                    userAds.push({ id: doc.id, ...doc.data() });
                });

                // Update statistics
                console.log('üìä Calling updateStatistics with:', { userAds: userAds.length, userProfile });
                updateStatistics(userAds, userProfile);
                
                // Load all reviews and update rating after loading
                loadAllUserReviews(currentUser.uid);

            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ dat u≈æivatele:', error);
            }
        }

        // Update statistics with real data
        function updateStatistics(userAds, userProfile) {
            console.log('üìä Updating statistics:', { userAds, userProfile });
            
            // Active ads count (podpora r≈Øzn√Ωch pol√≠ stavu)
            const activeAds = (userAds || []).filter(ad => {
                if (ad.status) return ad.status === 'active';
                if (typeof ad.active === 'boolean') return ad.active === true;
                if (typeof ad.isActive === 'boolean') return ad.isActive === true;
                return true; // pokud nen√≠ uvedeno, pova≈æuj za aktivn√≠
            }).length;
            const activeAdsElement = document.getElementById('activeAdsCount');
            if (activeAdsElement) {
                activeAdsElement.textContent = String(activeAds);
            }

            // Reset hodnocen√≠ ‚Äì dopln√≠ se po naƒçten√≠ reviews
            const ratingElement = document.getElementById('avgRatingValue');
            if (ratingElement) {
                ratingElement.textContent = '-';
            }
        }

        // Load all user reviews (profile + ads)
        async function loadAllUserReviews(userId) {
            console.log('‚≠ê Loading all reviews for user:', userId);
            try {
                const { getDocs, collection, collectionGroup } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                // Load profile reviews
                const profileReviewsRef = collection(window.firebaseDb, 'users', userId, 'reviews');
                const profileSnap = await getDocs(profileReviewsRef);
                const profileReviews = profileSnap.docs.map(d => ({ 
                    id: d.id, 
                    ...d.data(),
                    type: 'profile'
                }));

                // Load ad reviews using collectionGroup
                const adReviewsGroup = collectionGroup(window.firebaseDb, 'reviews');
                const adReviews = [];
                const groupSnap = await getDocs(adReviewsGroup);
                groupSnap.forEach(docSnap => {
                    const parent = docSnap.ref.parent; // reviews collection
                    const adDoc = parent?.parent; // adId document
                    const inzeraty = adDoc?.parent; // 'inzeraty' collection
                    const userDoc = inzeraty?.parent; // user uid document
                    if (userDoc && userDoc.id === userId && inzeraty.id === 'inzeraty') {
                        adReviews.push({ 
                            id: docSnap.id, 
                            ...docSnap.data(),
                            type: 'ad',
                            adId: adDoc.id
                        });
                    }
                });

                // Combine all reviews
                const allReviews = [...profileReviews, ...adReviews];
                console.log('üìä Found reviews:', { 
                    profile: profileReviews.length, 
                    ads: adReviews.length, 
                    total: allReviews.length 
                });

                // Update rating in statistics after loading reviews
                updateRatingFromReviews(allReviews);

            } catch (error) {
                console.error('‚ùå Error loading reviews:', error);
            }
        }

        // Update rating in statistics from reviews
        function updateRatingFromReviews(reviews) {
            console.log('üîÑ Updating rating from reviews:', reviews.length);
            
            // Calculate average rating
            const avgRating = reviews.length > 0 ? 
                (reviews.reduce((sum, r) => sum + (r.rating || 0), 0) / reviews.length) : 0;
            
            const ratingElement = document.getElementById('avgRatingValue');
            if (!ratingElement) return;
            ratingElement.textContent = reviews.length > 0 ? avgRating.toFixed(1) : '-';
            console.log('üìù Updated rating from reviews:', avgRating.toFixed(1), 'reviews:', reviews.length);
        }
    </script>
    <!-- Naƒçten√≠ skript≈Ø pro spr√°vn√© zobrazen√≠ navbaru -->
    <script src="profanity-filter.js"></script>
    <script src="script.js" defer></script>
    <script src="auth.js" defer></script>
    <script>
        // Definovat toggleMobileMenu p≈ô√≠mo na str√°nce nastaven√≠
        function toggleMobileMenuSettings() {
            const sidebar = document.querySelector('.sidebar');
            const body = document.body;
            const menuBtn = document.querySelector('.mobile-menu-btn');
            const isOpen = sidebar && sidebar.classList.contains('mobile-open');
            
            if (isOpen) {
                sidebar.classList.remove('mobile-open');
                body.classList.remove('sidebar-open');
                const overlay = document.querySelector('.sidebar-overlay');
                if (overlay) overlay.remove();
                if (menuBtn) menuBtn.style.display = 'flex';
            } else {
                if (sidebar) sidebar.classList.add('mobile-open');
                body.classList.add('sidebar-open');
                if (menuBtn) menuBtn.style.display = 'none';
                
                const overlay = document.createElement('div');
                overlay.className = 'sidebar-overlay';
                overlay.style.cssText = `
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    bottom: 0 !important;
                    width: 100vw !important;
                    height: 100vh !important;
                    background: rgba(0, 0, 0, 0.5) !important;
                    z-index: 1999 !important;
                `;
                overlay.addEventListener('click', toggleMobileMenuSettings);
                document.body.appendChild(overlay);
            }
        }
        
        // Exportovat funkci glob√°lnƒõ
        window.toggleMobileMenu = toggleMobileMenuSettings;
        
        // Zajistit, ≈æe mobile menu button funguje
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn') || document.querySelector('.mobile-menu-btn');
            if (mobileMenuBtn) {
                // Odstranit onclick a p≈ôidat event listener
                mobileMenuBtn.removeAttribute('onclick');
                
                function handleMenuClick(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    if (typeof window.toggleMobileMenu === 'function') {
                        window.toggleMobileMenu();
                    } else {
                        toggleMobileMenuSettings();
                    }
                }
                
                mobileMenuBtn.addEventListener('click', handleMenuClick, true);
                mobileMenuBtn.addEventListener('touchend', handleMenuClick, true);
                
                // Zajistit, ≈æe tlaƒç√≠tko je viditeln√© a klikateln√©
                mobileMenuBtn.style.zIndex = '99999';
                mobileMenuBtn.style.pointerEvents = 'auto';
                mobileMenuBtn.style.position = 'fixed';
                mobileMenuBtn.style.top = '8px';
                mobileMenuBtn.style.left = '8px';
            }
        });
        
        // Tak√© zkusit po naƒçten√≠ v≈°ech skript≈Ø
        window.addEventListener('load', function() {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn') || document.querySelector('.mobile-menu-btn');
            if (mobileMenuBtn && typeof window.toggleMobileMenu !== 'function') {
                window.toggleMobileMenu = toggleMobileMenuSettings;
            }
        });
    </script>
</body>
</html>
